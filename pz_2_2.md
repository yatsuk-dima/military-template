# üìò –ü—Ä–∞–∫—Ç–∏—á–Ω–µ –ó–∞–Ω—è—Ç—Ç—è 2/2 (ENTERPRISE FEATURES)

**–¢–µ–º–∞:** –î–æ–¥–∞–≤–∞–Ω–Ω—è enterprise-grade —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—É. Database Migrations, Security, Caching, Events  
**–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å:** 8 –∞–∫–∞–¥–µ–º—ñ—á–Ω–∏—Ö –≥–æ–¥–∏–Ω (4 –∑–∞–Ω—è—Ç—Ç—è –ø–æ 90 —Ö–≤–∏–ª–∏–Ω)  
**–†–æ–±–æ—á–∏–π —á–∞—Å:** 7 –≥–æ–¥–∏–Ω 15 —Ö–≤–∏–ª–∏–Ω (45 —Ö–≤–∏–ª–∏–Ω - –∑–¥–∞—á–∞)  
**–û—Ü—ñ–Ω–∫–∞:** 40 –±–∞–ª—ñ–≤  

---

## üéØ –ú–ï–¢–ê –ó–ê–ù–Ø–¢–¢–Ø

**–ü–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –±–∞–∑–æ–≤–∏–π CRUD API –Ω–∞ production-ready backend** –∑:
- ‚úÖ **Liquibase** - –≤–µ—Ä—Å—ñ–π–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ë–î
- ‚úÖ **JWT Security** - –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
- ‚úÖ **MapStruct** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –º–∞–ø–ø—ñ–Ω–≥ DTO
- ‚úÖ **Redis Caching** - –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–µ—à—É–≤–∞–Ω–Ω—è
- ‚úÖ **Spring Events** - event-driven –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
- ‚úÖ **MovementLog** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∏–π –æ–±–ª—ñ–∫ –æ–ø–µ—Ä–∞—Ü—ñ–π
- ‚úÖ **Observability** - metrics —Ç–∞ structured logging

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** Enterprise-grade REST API –≥–æ—Ç–æ–≤–∏–π –¥–æ production deployment

---

## ‚ö†Ô∏è –ü–ï–†–ï–î–£–ú–û–í–ò

**–û–±–æ–≤'—è–∑–∫–æ–≤–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø–µ—Ä–µ–¥ –ø–æ—á–∞—Ç–∫–æ–º:**

1. ‚úÖ **Stage 1 –∑–∞–≤–µ—Ä—à–µ–Ω–æ —Ç–∞ –∑–¥–∞–Ω–æ**
   - Entity, Repository, Service, Controllers –ø—Ä–∞—Ü—é—é—Ç—å
   - Pull Request —Å—Ö–≤–∞–ª–µ–Ω–æ –≤–∏–∫–ª–∞–¥–∞—á–µ–º
   
2. ‚úÖ **–ì—ñ–ª–∫–∞ stage-2 —Å—Ç–≤–æ—Ä–µ–Ω–∞**
   ```bash
   git checkout main
   git pull origin main
   git checkout -b stage-2
   ```

3. ‚úÖ **–ë–î –æ—á–∏—â–µ–Ω–∞ (–¥–ª—è Liquibase)**
   ```bash
   # –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ
   docker-compose down -v
   docker-compose up -d
   ```

4. ‚úÖ **–ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –¥–æ–¥–∞–Ω—ñ –≤ pom.xml** (–±—É–¥–µ–º–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –ø–æ–∫—Ä–æ–∫–æ–≤–æ)

---

## üìÖ –†–û–ó–ü–û–î–Ü–õ –ß–ê–°–£

### **–ó–∞–Ω—è—Ç—Ç—è 1 (90 —Ö–≤–∏–ª–∏–Ω): Database Management**

**[0-50 —Ö–≤] Liquibase –º—ñ–≥—Ä–∞—Ü—ñ—ó**
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Liquibase
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è changesets
- –ú—ñ–≥—Ä–∞—Ü—ñ—è —ñ—Å–Ω—É—é—á–æ—ó —Å—Ö–µ–º–∏
- Seed data (—Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ)

**[50-90 —Ö–≤] MovementLog Entity + –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó**
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è MovementLog Entity
- –°–∫–ª–∞–¥–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑ —Ä—ñ–∑–Ω–∏–º–∏ propagation
- Optimistic locking (@Version)
- Audit trail

---

### **–ó–∞–Ω—è—Ç—Ç—è 2 (90 —Ö–≤–∏–ª–∏–Ω): Security & Mapping**

**[0-45 —Ö–≤] JWT Authentication**
- User/Role Entity
- Security Configuration
- JWT Token generation/validation
- Login/Register endpoints

**[45-90 —Ö–≤] MapStruct**
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è MapStruct
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Mapper —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–≤
- –ó–∞–º—ñ–Ω–∞ —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø—ñ–Ω–≥—É
- –°–∫–ª–∞–¥–Ω—ñ mappings –∑ –≤–∫–ª–∞–¥–µ–Ω–∏–º–∏ –æ–±'—î–∫—Ç–∞–º–∏

---

### **–ó–∞–Ω—è—Ç—Ç—è 3 (90 —Ö–≤–∏–ª–∏–Ω): Performance & Events**

**[0-45 —Ö–≤] Redis Caching**
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Redis —á–µ—Ä–µ–∑ Docker
- @Cacheable –Ω–∞ Service –º–µ—Ç–æ–¥–∞—Ö
- @CacheEvict –¥–ª—è invalidation
- Cache configuration

**[45-90 —Ö–≤] Spring Events + Observability**
- Event classes —Ç–∞ EventListener
- @Async –æ–±—Ä–æ–±–∫–∞
- Custom metrics —á–µ—Ä–µ–∑ Micrometer
- Structured logging (JSON)

---

### **–ó–∞–Ω—è—Ç—Ç—è 4 (90 —Ö–≤–∏–ª–∏–Ω): –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–∑—Ä–æ–±–∫–∏ —Ç–∞ –∑–¥–∞—á–∞**

**[0-45 —Ö–≤] –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–æ–∑—Ä–æ–±–∫–∏**
- –î–æ–æ–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è –Ω–µ–∑–∞–∫—ñ–Ω—á–µ–Ω–∏—Ö —Ñ—ñ—á
- –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö endpoints
- –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫
- –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –∑–¥–∞—á—ñ

**[45-90 —Ö–≤] –ó–¥–∞—á–∞ —Ä–æ–±–æ—Ç–∏**
- –Ü–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω–∞ –∑–¥–∞—á–∞ –∑ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—î—é (20-25 —Ö–≤ –Ω–∞ –∫—É—Ä—Å–∞–Ω—Ç–∞)
- –ü–æ—è—Å–Ω–µ–Ω–Ω—è –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–∏—Ö —Ä—ñ—à–µ–Ω—å
- –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è
- –í–∏—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –æ—Ü—ñ–Ω–∫–∏

---

## üóÑÔ∏è –ï–¢–ê–ü 1: LIQUIBASE –ú–Ü–ì–†–ê–¶–Ü–á (50 —Ö–≤)

### –©–æ —Ç–∞–∫–µ Liquibase?

**Liquibase** - —Ü–µ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –≤–µ—Ä—Å—ñ–π–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å—Ö–µ–º–æ—é –ë–î.

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ Liquibase:**
```java
// application.properties
spring.jpa.hibernate.ddl-auto=update  // ‚ùå –ù–µ–±–µ–∑–ø–µ—á–Ω–æ –¥–ª—è production!
```

**–ß–æ–º—É `ddl-auto=update` –ø–æ–≥–∞–Ω–æ:**
- üö´ Hibernate –º–æ–∂–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –¥–∞–Ω—ñ –ø—Ä–∏ –∑–º—ñ–Ω—ñ Entity
- üö´ –ù–µ–º–∞—î —ñ—Å—Ç–æ—Ä—ñ—ó –∑–º—ñ–Ω —Å—Ö–µ–º–∏
- üö´ –ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –∑–º—ñ–Ω–∏
- üö´ –†—ñ–∑–Ω—ñ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∏ –º–∞—é—Ç—å —Ä—ñ–∑–Ω—ñ —Å—Ö–µ–º–∏
- üö´ Production —Ç–∞ development –ë–î —Ä–æ–∑—Ö–æ–¥—è—Ç—å—Å—è

**–†—ñ—à–µ–Ω–Ω—è - Liquibase:**
- ‚úÖ –í–µ—Ä—Å—ñ–π–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å —Å—Ö–µ–º–∏ –ë–î (—è–∫ Git –¥–ª—è –∫–æ–¥—É)
- ‚úÖ –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å rollback
- ‚úÖ –û–¥–Ω–∞–∫–æ–≤–∞ —Å—Ö–µ–º–∞ –Ω–∞ –≤—Å—ñ—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω
- ‚úÖ Seed data (–ø–æ—á–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ)

---

### –î–æ–¥–∞–≤–∞–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

**–£ `pom.xml` –¥–æ–¥–∞–π—Ç–µ:**

```xml
<!-- Liquibase –¥–ª—è –º—ñ–≥—Ä–∞—Ü—ñ–π –ë–î -->
<dependency>
    <groupId>org.liquibase</groupId>
    <artifactId>liquibase-core</artifactId>
</dependency>
```

**–ü—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è:**
```bash
mvn clean install
```

---

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Liquibase changesets

**–°—Ç–≤–æ—Ä—ñ—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫:**

```
src/main/resources/
‚îî‚îÄ‚îÄ db/
    ‚îî‚îÄ‚îÄ changelog/
        ‚îú‚îÄ‚îÄ db.changelog-master.xml          # –ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª
        ‚îú‚îÄ‚îÄ changes/
        ‚îÇ   ‚îú‚îÄ‚îÄ 001-create-categories.xml
        ‚îÇ   ‚îú‚îÄ‚îÄ 002-create-items.xml
        ‚îÇ   ‚îú‚îÄ‚îÄ 003-create-locations.xml
        ‚îÇ   ‚îú‚îÄ‚îÄ 004-create-movement-log.xml
        ‚îÇ   ‚îú‚îÄ‚îÄ 005-create-users-roles.xml
        ‚îÇ   ‚îî‚îÄ‚îÄ 006-add-indexes.xml
        ‚îî‚îÄ‚îÄ data/
            ‚îú‚îÄ‚îÄ seed-categories.xml
            ‚îî‚îÄ‚îÄ seed-test-data.xml
```

---

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è application.properties

**–ó–º—ñ–Ω—ñ—Ç—å:**

```properties
# –í–ê–ñ–õ–ò–í–û: –í–∏–º–∫–Ω—ñ—Ç—å Hibernate DDL
spring.jpa.hibernate.ddl-auto=none  # –¢–µ–ø–µ—Ä Liquibase –∫–µ—Ä—É—î —Å—Ö–µ–º–æ—é!

# Liquibase Configuration
spring.liquibase.change-log=classpath:db/changelog/db.changelog-master.xml
spring.liquibase.enabled=true
spring.liquibase.drop-first=false  # –ù–ï –≤–∏–¥–∞–ª—è—Ç–∏ –ë–î –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ (–Ω–µ–±–µ–∑–ø–µ—á–Ω–æ!)

# –ü–æ–∫–∞–∑—É–≤–∞—Ç–∏ SQL –¥–ª—è –≤—ñ–¥–ª–∞–¥–∫–∏
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
```

**–£–≤–∞–≥–∞:** `ddl-auto=none` –æ–∑–Ω–∞—á–∞—î —â–æ Hibernate **–ù–ï** –∑–º—ñ–Ω—é—î —Å—Ö–µ–º—É, —Ç—ñ–ª—å–∫–∏ Liquibase!

---

### –ì–æ–ª–æ–≤–Ω–∏–π changelog —Ñ–∞–π–ª

**`db/changelog/db.changelog-master.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ö–µ–º–∏ -->
    <include file="db/changelog/changes/001-create-categories.xml"/>
    <include file="db/changelog/changes/002-create-items.xml"/>
    <include file="db/changelog/changes/003-create-locations.xml"/>
    <include file="db/changelog/changes/004-create-movement-log.xml"/>
    <include file="db/changelog/changes/005-create-users-roles.xml"/>
    <include file="db/changelog/changes/006-add-indexes.xml"/>
    
    <!-- 2. Seed data -->
    <include file="db/changelog/data/seed-categories.xml"/>
    <include file="db/changelog/data/seed-test-data.xml"/>

</databaseChangeLog>
```

**–Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î:**
1. –ü—Ä–∏ –∑–∞–ø—É—Å–∫—É –¥–æ–¥–∞—Ç–∫—É Liquibase —á–∏—Ç–∞—î `db.changelog-master.xml`
2. –í–∏–∫–æ–Ω—É—î changesets –ø–æ –ø–æ—Ä—è–¥–∫—É (—è–∫—â–æ –≤–æ–Ω–∏ —â–µ –Ω–µ –≤–∏–∫–æ–Ω–∞–Ω—ñ)
3. –ó–±–µ—Ä—ñ–≥–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤–∏–∫–æ–Ω–∞–Ω—ñ changesets –≤ —Ç–∞–±–ª–∏—Ü—ñ `DATABASECHANGELOG`
4. –ü—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É - –ø—Ä–æ–ø—É—Å–∫–∞—î –≤–∂–µ –≤–∏–∫–æ–Ω–∞–Ω—ñ

---

### –ü—Ä–∏–∫–ª–∞–¥ changeset - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Categories

**–í–∞—Ä—ñ–∞–Ω—Ç A (–ú–¢–ó): `001-create-categories.xml`**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="001-create-supply-categories" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –ú–¢–ó</comment>
        
        <createTable tableName="supply_categories">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            
            <column name="code" type="VARCHAR(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            
            <column name="description" type="VARCHAR(500)"/>
            
            <column name="requires_cold_storage" type="BOOLEAN" defaultValueBoolean="false"/>
            
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <rollback>
            <dropTable tableName="supply_categories"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
```

**–í–∞–∂–ª–∏–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏:**
- `id` - —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID changeset (–Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø–æ–≤—Ç–æ—Ä—é—î—Ç—å—Å—è!)
- `author` - –≤–∞—à–µ —ñ–º'—è
- `<comment>` - –æ–ø–∏—Å —â–æ —Ä–æ–±–∏—Ç—å changeset
- `<createTable>` - —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ
- `<rollback>` - —è–∫ –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –∑–º—ñ–Ω–∏

---

### –ü—Ä–∏–∫–ª–∞–¥ changeset - –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Items

**–í–∞—Ä—ñ–∞–Ω—Ç A (–ú–¢–ó): `002-create-items.xml`**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="002-create-supply-items" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –ú–¢–ó</comment>
        
        <createTable tableName="supply_items">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <column name="name" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>
            
            <column name="batch_number" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            
            <column name="category_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            
            <column name="unit" type="VARCHAR(20)" defaultValue="—à—Ç"/>
            
            <column name="expiration_date" type="DATE"/>
            
            <column name="hazard_class" type="VARCHAR(30)">
                <constraints nullable="false"/>
            </column>
            
            <column name="storage_conditions" type="VARCHAR(200)"/>
            
            <column name="warehouse_id" type="BIGINT"/>
            
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <!-- –î–æ–¥–∞–≤–∞–Ω–Ω—è Foreign Keys -->
        <addForeignKeyConstraint 
            baseTableName="supply_items"
            baseColumnNames="category_id"
            referencedTableName="supply_categories"
            referencedColumnNames="id"
            constraintName="fk_items_category"
            onDelete="RESTRICT"/>
        
        <addForeignKeyConstraint 
            baseTableName="supply_items"
            baseColumnNames="warehouse_id"
            referencedTableName="warehouses"
            referencedColumnNames="id"
            constraintName="fk_items_warehouse"
            onDelete="SET NULL"/>
        
        <rollback>
            <dropForeignKeyConstraint 
                baseTableName="supply_items"
                constraintName="fk_items_category"/>
            <dropForeignKeyConstraint 
                baseTableName="supply_items"
                constraintName="fk_items_warehouse"/>
            <dropTable tableName="supply_items"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
```

**–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É:**
- `onDelete="RESTRICT"` - –Ω–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ —è–∫—â–æ —î –∑–∞–ª–µ–∂–Ω—ñ –∑–∞–ø–∏—Å–∏
- `onDelete="SET NULL"` - –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ parent ‚Üí NULL –≤ child
- `onDelete="CASCADE"` - –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ parent ‚Üí –≤–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ child (–Ω–µ–±–µ–∑–ø–µ—á–Ω–æ!)

---

### –î–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ

**`006-add-indexes.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="006-add-indexes" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–î–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–Ω–¥–µ–∫—Å—ñ–≤ –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ</comment>
        
        <!-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—à—É–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
        <createIndex indexName="idx_items_status" tableName="supply_items">
            <column name="status"/>
        </createIndex>
        
        <!-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—à—É–∫—É –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó -->
        <createIndex indexName="idx_items_category" tableName="supply_items">
            <column name="category_id"/>
        </createIndex>
        
        <!-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—à—É–∫—É –ø–æ —Å–∫–ª–∞–¥—É -->
        <createIndex indexName="idx_items_warehouse" tableName="supply_items">
            <column name="warehouse_id"/>
        </createIndex>
        
        <!-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—à—É–∫—É –ø–æ —Ç–µ—Ä–º—ñ–Ω—É –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ -->
        <createIndex indexName="idx_items_expiration" tableName="supply_items">
            <column name="expiration_date"/>
        </createIndex>
        
        <!-- –ö–æ–º–ø–æ–∑–∏—Ç–Ω–∏–π —ñ–Ω–¥–µ–∫—Å –¥–ª—è —á–∞—Å—Ç–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤ -->
        <createIndex indexName="idx_items_status_category" tableName="supply_items">
            <column name="status"/>
            <column name="category_id"/>
        </createIndex>
        
        <rollback>
            <dropIndex indexName="idx_items_status" tableName="supply_items"/>
            <dropIndex indexName="idx_items_category" tableName="supply_items"/>
            <dropIndex indexName="idx_items_warehouse" tableName="supply_items"/>
            <dropIndex indexName="idx_items_expiration" tableName="supply_items"/>
            <dropIndex indexName="idx_items_status_category" tableName="supply_items"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
```

**–ù–∞–≤—ñ—â–æ —ñ–Ω–¥–µ–∫—Å–∏:**
- üöÄ –ü—Ä–∏—à–≤–∏–¥—à—É—é—Ç—å SELECT –∑–∞–ø–∏—Ç–∏
- üöÄ WHERE, ORDER BY, JOIN —Å—Ç–∞—é—Ç—å —à–≤–∏–¥—à–∏–º–∏
- ‚ö†Ô∏è –°–ø–æ–≤—ñ–ª—å–Ω—é—é—Ç—å INSERT/UPDATE (—Ç—Ä–µ–±–∞ –æ–Ω–æ–≤–∏—Ç–∏ —ñ–Ω–¥–µ–∫—Å)

**–ö–æ–ª–∏ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —ñ–Ω–¥–µ–∫—Å:**
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∏ –≤ WHERE —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∏ –≤ JOIN
- ‚úÖ –ö–æ–ª–æ–Ω–∫–∏ –≤ ORDER BY
- ‚ùå –†—ñ–¥–∫–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω—ñ –∫–æ–ª–æ–Ω–∫–∏
- ‚ùå –ö–æ–ª–æ–Ω–∫–∏ –∑ –º–∞–ª–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å (Boolean)

---

### Seed data - –ø–æ—á–∞—Ç–∫–æ–≤—ñ –¥–∞–Ω—ñ

**`data/seed-categories.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="seed-001-categories" author="–≤–∞—à–µ-—ñ–º'—è" context="dev">
        <comment>–î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä—ñ–π</comment>
        
        <insert tableName="supply_categories">
            <column name="name" value="–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏ 5.45–º–º"/>
            <column name="code" value="AMMO-545"/>
            <column name="description" value="–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏ –∫–∞–ª—ñ–±—Ä—É 5.45–º–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç—ñ–≤ –ê–ö-74"/>
            <column name="requires_cold_storage" valueBoolean="false"/>
        </insert>
        
        <insert tableName="supply_categories">
            <column name="name" value="–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏ 7.62–º–º"/>
            <column name="code" value="AMMO-762"/>
            <column name="description" value="–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏ –∫–∞–ª—ñ–±—Ä—É 7.62–º–º –¥–ª—è –∫—É–ª–µ–º–µ—Ç—ñ–≤"/>
            <column name="requires_cold_storage" valueBoolean="false"/>
        </insert>
        
        <insert tableName="supply_categories">
            <column name="name" value="–ü—Ä–æ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ"/>
            <column name="code" value="FOOD-001"/>
            <column name="description" value="–•–∞—Ä—á–æ–≤—ñ –ø—Ä–æ–¥—É–∫—Ç–∏ —Ç–∞ –∫–æ–Ω—Å–µ—Ä–≤–∏"/>
            <column name="requires_cold_storage" valueBoolean="true"/>
        </insert>
        
        <rollback>
            <delete tableName="supply_categories">
                <where>code IN ('AMMO-545', 'AMMO-762', 'FOOD-001')</where>
            </delete>
        </rollback>
    </changeSet>

</databaseChangeLog>
```

**–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É:**
- `context="dev"` - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∑–∞–ø—É—Å–∫–∞—î–º–æ –∑ `--contexts=dev`
- –î–ª—è production –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ

---

### –ó–∞–ø—É—Å–∫ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ Liquibase

**1. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –¥–æ–¥–∞—Ç–æ–∫:**

```bash
mvn spring-boot:run
```

**2. –î–∏–≤—ñ—Ç—å—Å—è –ª–æ–≥–∏:**

```
Liquibase: Successfully acquired change log lock
Liquibase: Creating database history table with name: public.databasechangelog
Liquibase: Reading from public.databasechangelog
Liquibase: Running changeset: db/changelog/changes/001-create-categories.xml::001-create-supply-categories
Liquibase: Running changeset: db/changelog/changes/002-create-items.xml::002-create-supply-items
Liquibase: Running changeset: db/changelog/changes/003-create-locations.xml::003-create-warehouses
...
Liquibase: Successfully released change log lock
```

‚úÖ –Ø–∫—â–æ –±–∞—á–∏—Ç–µ —Ü–µ - Liquibase –ø—Ä–∞—Ü—é—î!

---

**3. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ë–î:**

```sql
-- –¢–∞–±–ª–∏—Ü—è –∑ —ñ—Å—Ç–æ—Ä—ñ—î—é –º—ñ–≥—Ä–∞—Ü—ñ–π
SELECT * FROM databasechangelog;

-- –ú–∞—î –±—É—Ç–∏ –≤–∞—à—ñ changesets:
-- 001-create-supply-categories | –≤–∞—à–µ-—ñ–º'—è | EXECUTED | ...
-- 002-create-supply-items      | –≤–∞—à–µ-—ñ–º'—è | EXECUTED | ...

-- –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
\d supply_categories
\d supply_items
```

---

### –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –º—ñ–≥—Ä–∞—Ü—ñ–π (—è–∫ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Å—Ö–µ–º—É)

**–ü—Ä–∏–∫–ª–∞–¥: –¥–æ–¥–∞—Ç–∏ –ø–æ–ª–µ `minimumStock` –¥–æ items**

**–ù–ï –º—ñ–Ω—è–π—Ç–µ Entity –≤—ñ–¥—Ä–∞–∑—É!** –°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å changeset:

**`007-add-minimum-stock.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="007-add-minimum-stock-field" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ–ª—è –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å</comment>
        
        <addColumn tableName="supply_items">
            <column name="minimum_stock" type="INTEGER" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        
        <rollback>
            <dropColumn tableName="supply_items" columnName="minimum_stock"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
```

**–ü–æ—Ç—ñ–º –¥–æ–¥–∞–π—Ç–µ –≤ `db.changelog-master.xml`:**

```xml
<include file="db/changelog/changes/007-add-minimum-stock.xml"/>
```

**–¢–µ–ø–µ—Ä –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ Entity:**

```java
@Entity
@Table(name = "supply_items")
public class SupplyItem {
    // ...
    
    @Column(nullable = false)
    private Integer minimumStock = 0;
    
    // ...
}
```

**–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç—ñ—Ç—å –¥–æ–¥–∞—Ç–æ–∫** - Liquibase –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—Å—Ç—å –∫–æ–ª–æ–Ω–∫—É!

---

### –ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏ Liquibase

**–ß–µ—Ä–µ–∑ Maven:**

```bash
# –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —è–∫—ñ changesets –±—É–¥—É—Ç—å –≤–∏–∫–æ–Ω–∞–Ω—ñ
mvn liquibase:status

# –í–∏–∫–æ–Ω–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó –±–µ–∑ –∑–∞–ø—É—Å–∫—É –¥–æ–¥–∞—Ç–∫—É
mvn liquibase:update

# –í—ñ–¥–∫–æ—Ç–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π changeset
mvn liquibase:rollback -Dliquibase.rollbackCount=1

# –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ changelog –∑ —ñ—Å–Ω—É—é—á–æ—ó –ë–î (reverse engineering)
mvn liquibase:generateChangeLog

# –û—á–∏—Å—Ç–∏—Ç–∏ –ë–î
mvn liquibase:dropAll
```

---

### –ó–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –∫—É—Ä—Å–∞–Ω—Ç—ñ–≤ (Liquibase)

**–°—Ç–≤–æ—Ä—ñ—Ç—å changesets –¥–ª—è –í–ê–®–û–ì–û –≤–∞—Ä—ñ–∞–Ω—Ç—É:**

1. ‚úÖ `001-create-categories.yaml` - —Ç–∞–±–ª–∏—Ü—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
2. ‚úÖ `002-create-items.yaml` - —Ç–∞–±–ª–∏—Ü—è –æ—Å–Ω–æ–≤–Ω–∏—Ö entity (—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç/–ø–µ—Ä—Å–æ–Ω–∞–ª/–º–∞—Ç–µ—Ä—ñ–∞–ª–∏)
3. ‚úÖ `003-create-locations.yaml` - —Ç–∞–±–ª–∏—Ü—è —Å–∫–ª–∞–¥—ñ–≤/–≤–æ–¥—ñ—ó–≤/–ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤
4. ‚úÖ `004-create-movement-log.yaml` (–¥–∞–ª—ñ —Å—Ç–≤–æ—Ä–∏–º–æ)
5. ‚úÖ `005-create-users-roles.yaml` (–¥–∞–ª—ñ —Å—Ç–≤–æ—Ä–∏–º–æ)
6. ‚úÖ `006-add-indexes.yaml` - —ñ–Ω–¥–µ–∫—Å–∏ –¥–ª—è –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
7. ‚úÖ `seed-categories.yaml` - –º—ñ–Ω—ñ–º—É–º 3 –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
8. ‚úÖ `seed-test-data.yaml` - –º—ñ–Ω—ñ–º—É–º 5 items –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

**–ê–¥–∞–ø—Ç—É–π—Ç–µ –Ω–∞–∑–≤–∏ —Ç–∞–±–ª–∏—Ü—å —Ç–∞ –∫–æ–ª–æ–Ω–æ–∫ –ø—ñ–¥ –≤–∞—à –≤–∞—Ä—ñ–∞–Ω—Ç!**

---

## üìù –ï–¢–ê–ü 2: MOVEMENT LOG + –¢–†–ê–ù–ó–ê–ö–¶–Ü–á (40 —Ö–≤)

### –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω MovementLog?

**MovementLog** - —Ü–µ –∂—É—Ä–Ω–∞–ª –≤—Å—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –∑ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏/—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º/–ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º.

**–ü—Ä–∏–∫–ª–∞–¥–∏ –æ–ø–µ—Ä–∞—Ü—ñ–π:**
- –í–∞—Ä—ñ–∞–Ω—Ç A (–ú–¢–ó): –≤–∏–¥–∞—á–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤, –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è, —Å–ø–∏—Å–∞–Ω–Ω—è –ø–æ —Ç–µ—Ä–º—ñ–Ω—É
- –í–∞—Ä—ñ–∞–Ω—Ç B (–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç): –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –≤–æ–¥—ñ—è, –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ –¢–û, –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ –¢–û
- –í–∞—Ä—ñ–∞–Ω—Ç C (–ü–µ—Ä—Å–æ–Ω–∞–ª): –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞ –ø–æ—Å–∞–¥—É, –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–Ω—è, –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è

**–í–∏–º–æ–≥–∏:**
- ‚úÖ –ö–æ–∂–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è –º–∞—î –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è –≤ –ë–î
- ‚úÖ –ù–µ–º–æ–∂–ª–∏–≤–æ –≤–∏–¥–∞–ª–∏—Ç–∏ –∞–±–æ –∑–º—ñ–Ω–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
- ‚úÖ –ê—É–¥–∏—Ç: —Ö—Ç–æ, –∫–æ–ª–∏, —â–æ –∑—Ä–æ–±–∏–≤
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω—ñ—Å—Ç—å: –∞–±–æ –≤—Å–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è, –∞–±–æ –Ω—ñ—á–æ–≥–æ

---

### MovementLog Entity (–¥–ª—è –í–∞—Ä—ñ–∞–Ω—Ç—É A - –ú–¢–ó)

```java
package ua.edu.viti.warehouse.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;

@Entity
@Table(name = "supply_movements")
@EntityListeners(AuditingEntityListener.class)
@Data
@NoArgsConstructor
@AllArgsConstructor
public class SupplyMovement {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "item_id", nullable = false)
    private SupplyItem item;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false, length = 20)
    private MovementType type;  // ISSUE, RETURN, WRITE_OFF
    
    @Column(nullable = false)
    private Integer quantity;  // –ö—ñ–ª—å–∫—ñ—Å—Ç—å (–ø–æ–∑–∏—Ç–∏–≤–Ω–∞ –∞–±–æ –Ω–µ–≥–∞—Ç–∏–≤–Ω–∞)
    
    @Column(length = 100)
    private String recipientName;  // –ö–æ–º—É –≤–∏–¥–∞–Ω–æ (—è–∫—â–æ ISSUE)
    
    @Column(length = 50)
    private String recipientUnit;  // –ü—ñ–¥—Ä–æ–∑–¥—ñ–ª –æ—Ç—Ä–∏–º—É–≤–∞—á–∞
    
    @Column(length = 500)
    private String notes;  // –ü—Ä–∏–º—ñ—Ç–∫–∏
    
    @Column(length = 100)
    private String performedBy;  // –•—Ç–æ –≤–∏–∫–æ–Ω–∞–≤ –æ–ø–µ—Ä–∞—Ü—ñ—é
    
    @CreatedDate
    @Column(nullable = false, updatable = false)
    private LocalDateTime performedAt;
    
    // –í–ê–ñ–õ–ò–í–û: Optimistic Locking
    @Version
    private Long version;
}
```

**–ù–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç - `@Version`:**
```java
@Version
private Long version;
```

**–©–æ —Ü–µ:** Optimistic Locking - –º–µ—Ö–∞–Ω—ñ–∑–º –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –ø—Ä–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω–Ω—è—Ö.

**–Ø–∫ –ø—Ä–∞—Ü—é—î:**
1. –ü—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ Entity - –∑–∞–ø–∞–º'—è—Ç–æ–≤—É—î—Ç—å—Å—è `version`
2. –ü—Ä–∏ UPDATE - –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è —á–∏ `version` –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è
3. –Ø–∫—â–æ –∑–º—ñ–Ω–∏–≤—Å—è (—Ö—Ç–æ—Å—å —ñ–Ω—à–∏–π –≤–∂–µ –æ–Ω–æ–≤–∏–≤) ‚Üí `OptimisticLockException`
4. –Ø–∫—â–æ –Ω—ñ - –æ–Ω–æ–≤–ª—é—î —Ç–∞ —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—î `version`

**–ü—Ä–∏–∫–ª–∞–¥ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É:**
```
–ß–∞—Å | –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á 1                | –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á 2
-----|----------------------------|-----------------------------
T1   | READ item (version=5)      |
T2   |                            | READ item (version=5)
T3   | UPDATE (version=5‚Üí6) ‚úÖ     |
T4   |                            | UPDATE (version=5‚Üí6) ‚ùå CONFLICT!
```

---

### MovementType Enum

```java
package ua.edu.viti.warehouse.entity;

public enum MovementType {
    ISSUE,      // –í–∏–¥–∞—á–∞
    RETURN,     // –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
    WRITE_OFF,  // –°–ø–∏—Å–∞–Ω–Ω—è
    TRANSFER    // –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –º—ñ–∂ —Å–∫–ª–∞–¥–∞–º–∏
}
```

---

### Liquibase changeset –¥–ª—è MovementLog

**`004-create-movement-log.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="004-create-supply-movements" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∂—É—Ä–Ω–∞–ª—É –æ–ø–µ—Ä–∞—Ü—ñ–π –∑ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏</comment>
        
        <createTable tableName="supply_movements">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <column name="item_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            
            <column name="type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            
            <column name="quantity" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            
            <column name="recipient_name" type="VARCHAR(100)"/>
            
            <column name="recipient_unit" type="VARCHAR(50)"/>
            
            <column name="notes" type="VARCHAR(500)"/>
            
            <column name="performed_by" type="VARCHAR(100)"/>
            
            <column name="performed_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            
            <column name="version" type="BIGINT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addForeignKeyConstraint 
            baseTableName="supply_movements"
            baseColumnNames="item_id"
            referencedTableName="supply_items"
            referencedColumnNames="id"
            constraintName="fk_movements_item"
            onDelete="RESTRICT"/>
        
        <!-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—à—É–∫—É –ø–æ item -->
        <createIndex indexName="idx_movements_item" tableName="supply_movements">
            <column name="item_id"/>
        </createIndex>
        
        <!-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—à—É–∫—É –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü—ñ—ó -->
        <createIndex indexName="idx_movements_type" tableName="supply_movements">
            <column name="type"/>
        </createIndex>
        
        <!-- –Ü–Ω–¥–µ–∫—Å –¥–ª—è –ø–æ—à—É–∫—É –ø–æ –¥–∞—Ç—ñ (–Ω–æ–≤—ñ—à—ñ —Å–ø–æ—á–∞—Ç–∫—É) -->
        <createIndex indexName="idx_movements_date" tableName="supply_movements">
            <column name="performed_at" descending="true"/>
        </createIndex>
        
        <rollback>
            <dropTable tableName="supply_movements"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
```

---

### MovementRepository

```java
package ua.edu.viti.warehouse.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import ua.edu.viti.warehouse.entity.MovementType;
import ua.edu.viti.warehouse.entity.SupplyMovement;

import java.time.LocalDateTime;
import java.util.List;

@Repository
public interface SupplyMovementRepository extends JpaRepository<SupplyMovement, Long> {
    
    // –Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ item
    List<SupplyMovement> findByItemIdOrderByPerformedAtDesc(Long itemId);
    
    // –û–ø–µ—Ä–∞—Ü—ñ—ó –ø–µ–≤–Ω–æ–≥–æ —Ç–∏–ø—É
    List<SupplyMovement> findByType(MovementType type);
    
    // –û–ø–µ—Ä–∞—Ü—ñ—ó –∑–∞ –ø–µ—Ä—ñ–æ–¥
    List<SupplyMovement> findByPerformedAtBetween(
        LocalDateTime start, 
        LocalDateTime end
    );
    
    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —Å—É–º–∞—Ä–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤–∏–¥–∞–Ω–æ–≥–æ –∑–∞ –ø–µ—Ä—ñ–æ–¥
    @Query("SELECT SUM(m.quantity) FROM SupplyMovement m " +
           "WHERE m.type = :type AND m.performedAt BETWEEN :start AND :end")
    Integer calculateTotalQuantity(
        MovementType type,
        LocalDateTime start,
        LocalDateTime end
    );
}
```

---

### MovementService –∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏

**DTO –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π:**

```java
package ua.edu.viti.warehouse.dto.request;

import jakarta.validation.constraints.*;
import lombok.Data;
import ua.edu.viti.warehouse.entity.MovementType;

@Data
public class MovementRequestDTO {
    
    @NotNull(message = "ID –º–∞—Ç–µ—Ä—ñ–∞–ª—É –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π")
    @Positive
    private Long itemId;
    
    @NotNull(message = "–¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π")
    private MovementType type;
    
    @NotNull(message = "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ–±–æ–≤'—è–∑–∫–æ–≤–∞")
    @Positive(message = "–ö—ñ–ª—å–∫—ñ—Å—Ç—å –º–∞—î –±—É—Ç–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ—é")
    private Integer quantity;
    
    @Size(max = 100)
    private String recipientName;
    
    @Size(max = 50)
    private String recipientUnit;
    
    @Size(max = 500)
    private String notes;
}
```

---

**MovementService:**

```java
package ua.edu.viti.warehouse.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import ua.edu.viti.warehouse.dto.request.MovementRequestDTO;
import ua.edu.viti.warehouse.dto.response.MovementResponseDTO;
import ua.edu.viti.warehouse.entity.*;
import ua.edu.viti.warehouse.exception.*;
import ua.edu.viti.warehouse.repository.*;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;

@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class SupplyMovementService {
    
    private final SupplyMovementRepository movementRepository;
    private final SupplyItemRepository itemRepository;
    
    /**
     * –í–∏–¥–∞—á–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
     * 
     * –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –∑ REPEATABLE_READ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è phantom reads
     */
    @Transactional(
        isolation = Isolation.REPEATABLE_READ,
        rollbackFor = Exception.class
    )
    public MovementResponseDTO issueItem(MovementRequestDTO dto) {
        log.info("Issuing item: itemId={}, quantity={}", dto.getItemId(), dto.getQuantity());
        
        // 1. –ó–Ω–∞–π—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª (–∑ pessimistic lock)
        SupplyItem item = itemRepository.findById(dto.getItemId())
            .orElseThrow(() -> new ResourceNotFoundException("–ú–∞—Ç–µ—Ä—ñ–∞–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"));
        
        // 2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
        if (item.getStatus() != ItemStatus.IN_STOCK) {
            throw new BusinessLogicException("–ú–∞—Ç–µ—Ä—ñ–∞–ª –Ω–µ –Ω–∞ —Å–∫–ª–∞–¥—ñ (—Å—Ç–∞—Ç—É—Å: " + item.getStatus() + ")");
        }
        
        // 3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–µ—Ä–º—ñ–Ω –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ
        if (item.getExpirationDate() != null && 
            item.getExpirationDate().isBefore(LocalDate.now())) {
            throw new BusinessLogicException("–ù–µ –º–æ–∂–Ω–∞ –≤–∏–¥–∞—Ç–∏ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π –º–∞—Ç–µ—Ä—ñ–∞–ª");
        }
        
        // 4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å
        if (item.getQuantity() < dto.getQuantity()) {
            throw new BusinessLogicException(
                String.format("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤. –î–æ—Å—Ç—É–ø–Ω–æ: %d, –∑–∞–ø–∏—Ç–∞–Ω–æ: %d",
                    item.getQuantity(), dto.getQuantity())
            );
        }
        
        // 5. –ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        item.setQuantity(item.getQuantity() - dto.getQuantity());
        
        // 6. –Ø–∫—â–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å = 0, –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
        if (item.getQuantity() == 0) {
            item.setStatus(ItemStatus.ISSUED);
        }
        
        itemRepository.save(item);
        
        // 7. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ –∂—É—Ä–Ω–∞–ª—ñ
        SupplyMovement movement = new SupplyMovement();
        movement.setItem(item);
        movement.setType(MovementType.ISSUE);
        movement.setQuantity(dto.getQuantity());
        movement.setRecipientName(dto.getRecipientName());
        movement.setRecipientUnit(dto.getRecipientUnit());
        movement.setNotes(dto.getNotes());
        movement.setPerformedBy(getCurrentUser());  // –ó Security Context (–¥–æ–¥–∞–º–æ –ø—ñ–∑–Ω—ñ—à–µ)
        
        SupplyMovement saved = movementRepository.save(movement);
        
        log.info("Item issued successfully. Movement ID: {}", saved.getId());
        
        return toResponseDTO(saved);
    }
    
    /**
     * –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
     */
    @Transactional(
        isolation = Isolation.REPEATABLE_READ,
        rollbackFor = Exception.class
    )
    public MovementResponseDTO returnItem(MovementRequestDTO dto) {
        log.info("Returning item: itemId={}, quantity={}", dto.getItemId(), dto.getQuantity());
        
        SupplyItem item = itemRepository.findById(dto.getItemId())
            .orElseThrow(() -> new ResourceNotFoundException("–ú–∞—Ç–µ—Ä—ñ–∞–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"));
        
        // –î–æ–¥–∞—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞–∑–∞–¥
        item.setQuantity(item.getQuantity() + dto.getQuantity());
        item.setStatus(ItemStatus.IN_STOCK);
        
        itemRepository.save(item);
        
        // –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ –∂—É—Ä–Ω–∞–ª—ñ
        SupplyMovement movement = new SupplyMovement();
        movement.setItem(item);
        movement.setType(MovementType.RETURN);
        movement.setQuantity(dto.getQuantity());
        movement.setNotes(dto.getNotes());
        movement.setPerformedBy(getCurrentUser());
        
        SupplyMovement saved = movementRepository.save(movement);
        
        log.info("Item returned successfully. Movement ID: {}", saved.getId());
        
        return toResponseDTO(saved);
    }
    
    /**
     * –°–ø–∏—Å–∞–Ω–Ω—è –ø–æ —Ç–µ—Ä–º—ñ–Ω—É –ø—Ä–∏–¥–∞—Ç–Ω–æ—Å—Ç—ñ –∞–±–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è
     */
    @Transactional(rollbackFor = Exception.class)
    public MovementResponseDTO writeOffItem(MovementRequestDTO dto) {
        log.info("Writing off item: itemId={}, quantity={}", dto.getItemId(), dto.getQuantity());
        
        SupplyItem item = itemRepository.findById(dto.getItemId())
            .orElseThrow(() -> new ResourceNotFoundException("–ú–∞—Ç–µ—Ä—ñ–∞–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"));
        
        if (item.getQuantity() < dto.getQuantity()) {
            throw new BusinessLogicException("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –¥–ª—è —Å–ø–∏—Å–∞–Ω–Ω—è");
        }
        
        // –ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        item.setQuantity(item.getQuantity() - dto.getQuantity());
        
        if (item.getQuantity() == 0) {
            item.setStatus(ItemStatus.WRITTEN_OFF);
        }
        
        itemRepository.save(item);
        
        // –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ –∂—É—Ä–Ω–∞–ª—ñ
        SupplyMovement movement = new SupplyMovement();
        movement.setItem(item);
        movement.setType(MovementType.WRITE_OFF);
        movement.setQuantity(dto.getQuantity());
        movement.setNotes(dto.getNotes());
        movement.setPerformedBy(getCurrentUser());
        
        SupplyMovement saved = movementRepository.save(movement);
        
        log.info("Item written off successfully. Movement ID: {}", saved.getId());
        
        return toResponseDTO(saved);
    }
    
    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –æ–ø–µ—Ä–∞—Ü—ñ–π –¥–ª—è –º–∞—Ç–µ—Ä—ñ–∞–ª—É
     */
    public List<MovementResponseDTO> getItemHistory(Long itemId) {
        return movementRepository.findByItemIdOrderByPerformedAtDesc(itemId)
            .stream()
            .map(this::toResponseDTO)
            .toList();
    }
    
    /**
     * –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä—ñ–æ–¥
     */
    public Integer calculateIssuedQuantity(LocalDateTime start, LocalDateTime end) {
        Integer total = movementRepository.calculateTotalQuantity(
            MovementType.ISSUE, start, end
        );
        return total != null ? total : 0;
    }
    
    // Helper –º–µ—Ç–æ–¥–∏
    
    private String getCurrentUser() {
        // TODO: –û—Ç—Ä–∏–º–∞—Ç–∏ –∑ Security Context –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è JWT
        return "system";
    }
    
    private MovementResponseDTO toResponseDTO(SupplyMovement movement) {
        MovementResponseDTO dto = new MovementResponseDTO();
        dto.setId(movement.getId());
        dto.setItemId(movement.getItem().getId());
        dto.setItemName(movement.getItem().getName());
        dto.setType(movement.getType());
        dto.setQuantity(movement.getQuantity());
        dto.setRecipientName(movement.getRecipientName());
        dto.setRecipientUnit(movement.getRecipientUnit());
        dto.setNotes(movement.getNotes());
        dto.setPerformedBy(movement.getPerformedBy());
        dto.setPerformedAt(movement.getPerformedAt());
        return dto;
    }
}
```

**–í–∞–∂–ª–∏–≤—ñ –º–æ–º–µ–Ω—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π:**

1. **`@Transactional(isolation = Isolation.REPEATABLE_READ)`**
   - –ó–∞–ø–æ–±—ñ–≥–∞—î phantom reads
   - –ì–∞—Ä–∞–Ω—Ç—É—î —â–æ –¥–∞–Ω—ñ –Ω–µ –∑–º—ñ–Ω—è—Ç—å—Å—è –ø—ñ–¥ —á–∞—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó

2. **`rollbackFor = Exception.class`**
   - –í—ñ–¥–∫–æ—Ç–∏—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –ø—Ä–∏ –±—É–¥—å-—è–∫—ñ–π –ø–æ–º–∏–ª—Ü—ñ
   - –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ç—ñ–ª—å–∫–∏ RuntimeException

3. **Pessimistic Locking (–æ–ø—Ü—ñ–π–Ω–æ):**
   ```java
   @Lock(LockModeType.PESSIMISTIC_WRITE)
   @Query("SELECT i FROM SupplyItem i WHERE i.id = :id")
   Optional<SupplyItem> findByIdWithLock(@Param("id") Long id);
   ```
   - –ë–ª–æ–∫—É—î —Ä—è–¥–æ–∫ –≤ –ë–î –¥–æ –∫—ñ–Ω—Ü—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
   - –ó–∞–ø–æ–±—ñ–≥–∞—î –æ–¥–Ω–æ—á–∞—Å–Ω–∏–º –∑–º—ñ–Ω–∞–º

---

### Propagation —Ä—ñ–≤–Ω—ñ (—Ä–æ–∑—à–∏—Ä–µ–Ω–∞ —Ç–µ–º–∞)

**–†—ñ–∑–Ω—ñ —Ç–∏–ø–∏ –ø–æ—à–∏—Ä–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π:**

```java
// REQUIRED (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) - –ø—Ä–∏—î–¥–Ω—É—î—Ç—å—Å—è –¥–æ —ñ—Å–Ω—É—é—á–æ—ó –∞–±–æ —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤—É
@Transactional(propagation = Propagation.REQUIRED)

// REQUIRES_NEW - –∑–∞–≤–∂–¥–∏ —Å—Ç–≤–æ—Ä—é—î –Ω–æ–≤—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é (suspend –ø–æ—Ç–æ—á–Ω—É)
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void logOperation() {
    // –¶—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ù–ï –≤—ñ–¥–∫–æ—Ç–∏—Ç—å—Å—è –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≥–æ–ª–æ–≤–Ω–∞ –≤—ñ–¥–∫–æ—Ç–∏—Ç—å—Å—è
}

// MANDATORY - –º–∞—î –±—É—Ç–∏ –≤–∏–∫–ª–∏–∫–∞–Ω–∏–π –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
@Transactional(propagation = Propagation.MANDATORY)

// NEVER - –ù–ï –º–æ–∂–Ω–∞ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
@Transactional(propagation = Propagation.NEVER)
```

**–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è REQUIRES_NEW:**

```java
@Service
public class AuditService {
    
    // –õ–æ–≥–∏ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≥–æ–ª–æ–≤–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è –≤—ñ–¥–∫–æ—Ç–∏–ª–∞—Å—å
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void auditFailure(String operation, String error) {
        AuditLog log = new AuditLog();
        log.setOperation(operation);
        log.setError(error);
        log.setTimestamp(LocalDateTime.now());
        auditRepository.save(log);
    }
}

@Service
public class ItemService {
    
    @Autowired
    private AuditService auditService;
    
    @Transactional
    public void dangerousOperation() {
        try {
            // –Ø–∫–∞—Å—å –æ–ø–µ—Ä–∞—Ü—ñ—è —â–æ –º–æ–∂–µ –∑–ª–∞–º–∞—Ç–∏—Å—å
            performOperation();
        } catch (Exception e) {
            // –ê—É–¥–∏—Ç –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –æ–∫—Ä–µ–º—ñ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
            auditService.auditFailure("dangerousOperation", e.getMessage());
            throw e;  // –ì–æ–ª–æ–≤–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –≤—ñ–¥–∫–æ—Ç–∏—Ç—å—Å—è
        }
    }
}
```

---

### MovementController

```java
package ua.edu.viti.warehouse.controller;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.format.annotation.DateTimeFormat;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import ua.edu.viti.warehouse.dto.request.MovementRequestDTO;
import ua.edu.viti.warehouse.dto.response.MovementResponseDTO;
import ua.edu.viti.warehouse.service.SupplyMovementService;

import java.time.LocalDateTime;
import java.util.List;

@RestController
@RequestMapping("/api/movements")
@RequiredArgsConstructor
@Slf4j
@Tag(name = "Supply Movements", description = "API –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π –∑ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏")
public class SupplyMovementController {
    
    private final SupplyMovementService movementService;
    
    @PostMapping("/issue")
    @Operation(summary = "–í–∏–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏")
    public ResponseEntity<MovementResponseDTO> issueItem(
            @Valid @RequestBody MovementRequestDTO dto) {
        
        MovementResponseDTO movement = movementService.issueItem(dto);
        return ResponseEntity.status(HttpStatus.CREATED).body(movement);
    }
    
    @PostMapping("/return")
    @Operation(summary = "–ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏")
    public ResponseEntity<MovementResponseDTO> returnItem(
            @Valid @RequestBody MovementRequestDTO dto) {
        
        MovementResponseDTO movement = movementService.returnItem(dto);
        return ResponseEntity.status(HttpStatus.CREATED).body(movement);
    }
    
    @PostMapping("/write-off")
    @Operation(summary = "–°–ø–∏—Å–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏")
    public ResponseEntity<MovementResponseDTO> writeOffItem(
            @Valid @RequestBody MovementRequestDTO dto) {
        
        MovementResponseDTO movement = movementService.writeOffItem(dto);
        return ResponseEntity.status(HttpStatus.CREATED).body(movement);
    }
    
    @GetMapping("/item/{itemId}")
    @Operation(summary = "–Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π –¥–ª—è –º–∞—Ç–µ—Ä—ñ–∞–ª—É")
    public ResponseEntity<List<MovementResponseDTO>> getItemHistory(
            @PathVariable Long itemId) {
        
        List<MovementResponseDTO> history = movementService.getItemHistory(itemId);
        return ResponseEntity.ok(history);
    }
    
    @GetMapping("/statistics/issued")
    @Operation(summary = "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–∏–¥–∞–Ω–∏—Ö –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤ –∑–∞ –ø–µ—Ä—ñ–æ–¥")
    public ResponseEntity<Integer> getIssuedQuantity(
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME) 
            LocalDateTime start,
            
            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.DATE_TIME)
            LocalDateTime end) {
        
        Integer total = movementService.calculateIssuedQuantity(start, end);
        return ResponseEntity.ok(total);
    }
}
```

---

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

**–°—Ü–µ–Ω–∞—Ä—ñ–π: —Å–ø—Ä–æ–±–∞ –≤–∏–¥–∞—Ç–∏ –±—ñ–ª—å—à–µ –Ω—ñ–∂ —î**

```json
POST /api/movements/issue
{
  "itemId": 1,
  "quantity": 10000,  // –ë—ñ–ª—å—à–µ –Ω—ñ–∂ —î –Ω–∞ —Å–∫–ª–∞–¥—ñ
  "recipientName": "–Ü–≤–∞–Ω–æ–≤ –Ü.–Ü.",
  "recipientUnit": "1-–∞ —Ä–æ—Ç–∞"
}
```

**–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
HTTP/1.1 400 Bad Request
{
  "type": "/errors/business-logic",
  "title": "Business Logic Violation",
  "status": 400,
  "detail": "–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤. –î–æ—Å—Ç—É–ø–Ω–æ: 5000, –∑–∞–ø–∏—Ç–∞–Ω–æ: 10000",
  ...
}
```

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞: –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ù–ï –∑–º–µ–Ω—à–∏–ª–∞—Å—å (—Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –≤—ñ–¥–∫–æ—Ç–∏–ª–∞—Å—å)**

---

## üîê –ï–¢–ê–ü 3: JWT SECURITY (45 —Ö–≤)

### –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è?

**–ë–µ–∑ Security:**
- ‚ùå –ë—É–¥—å-—Ö—Ç–æ –º–æ–∂–µ –≤–∏–¥–∞–≤–∞—Ç–∏/—Å–ø–∏—Å—É–≤–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏
- ‚ùå –ù–µ–º–∞—î –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É
- ‚ùå –ù–µ–º–æ–∂–ª–∏–≤–æ –≤—ñ–¥—Å—Ç–µ–∂–∏—Ç–∏ —Ö—Ç–æ –∑—Ä–æ–±–∏–≤ –æ–ø–µ—Ä–∞—Ü—ñ—é

**–ó JWT Security:**
- ‚úÖ –¢—ñ–ª—å–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ
- ‚úÖ –†—ñ–∑–Ω—ñ —Ä–æ–ª—ñ: ADMIN, OPERATOR, VIEWER
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–æ endpoints (@PreAuthorize)
- ‚úÖ –ê—É–¥–∏—Ç: —Ö—Ç–æ –≤–∏–∫–æ–Ω–∞–≤ –æ–ø–µ—Ä–∞—Ü—ñ—é

---

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ JWT

**–Ø–∫ –ø—Ä–∞—Ü—é—î JWT –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è:**

```
1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ‚Üí POST /api/auth/login (username, password)
2. Backend ‚Üí –ü–µ—Ä–µ–≤—ñ—Ä—è—î credentials
3. Backend ‚Üí –ì–µ–Ω–µ—Ä—É—î JWT token
4. Backend ‚Üí –ü–æ–≤–µ—Ä—Ç–∞—î token –∫–ª—ñ—î–Ω—Ç—É
5. –ö–ª—ñ—î–Ω—Ç ‚Üí –ó–±–µ—Ä—ñ–≥–∞—î token (localStorage)
6. –ö–ª—ñ—î–Ω—Ç ‚Üí –ö–æ–∂–µ–Ω –∑–∞–ø–∏—Ç: Authorization: Bearer <token>
7. Backend ‚Üí –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Ç–∞ —Ä–æ–∑–ø–∞–∫–æ–≤—É—î token
8. Backend ‚Üí –í–∏–∫–æ–Ω—É—î –∑–∞–ø–∏—Ç —è–∫—â–æ token –≤–∞–ª—ñ–¥–Ω–∏–π
```

**JWT Token —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:**
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VybmFtZSIsInJvbGVzIjpbIkFETUlOIl19.signature
‚îÇ                                      ‚îÇ                                            ‚îÇ
‚îÇ          Header                      ‚îÇ              Payload                       ‚îÇ    Signature
‚îÇ    (–∞–ª–≥–æ—Ä–∏—Ç–º, —Ç–∏–ø)                   ‚îÇ  (–¥–∞–Ω—ñ: username, roles, exp)              ‚îÇ   (–±–µ–∑–ø–µ–∫–∞)
```

---

### –î–æ–¥–∞–≤–∞–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π

**–£ `pom.xml` –¥–æ–¥–∞–π—Ç–µ:**

```xml
<!-- Spring Security -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>

<!-- JWT -->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-api</artifactId>
    <version>0.12.5</version>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-impl</artifactId>
    <version>0.12.5</version>
    <scope>runtime</scope>
</dependency>
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt-jackson</artifactId>
    <version>0.12.5</version>
    <scope>runtime</scope>
</dependency>
```

**–ü—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è:**
```bash
mvn clean install
```

---

### User —Ç–∞ Role Entity

**Role Entity:**

```java
package ua.edu.viti.warehouse.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Table(name = "roles")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Role {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false, unique = true, length = 20)
    private RoleName name;
    
    @Column(length = 200)
    private String description;
}
```

**RoleName Enum:**

```java
package ua.edu.viti.warehouse.entity;

public enum RoleName {
    ROLE_ADMIN,      // –ü–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø: —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è, —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è, –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    ROLE_OPERATOR,   // –û–ø–µ—Ä–∞—Ü—ñ—ó: –≤–∏–¥–∞—á–∞, –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è, —Å–ø–∏—Å–∞–Ω–Ω—è
    ROLE_VIEWER      // –¢—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥
}
```

**–ß–æ–º—É `ROLE_` prefix?** Spring Security –≤–∏–º–∞–≥–∞—î —Ü–µ–π –ø—Ä–µ—Ñ—ñ–∫—Å –¥–ª—è —Ä–æ–ª–µ–π.

---

**User Entity:**

```java
package ua.edu.viti.warehouse.entity;

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.Set;

@Entity
@Table(name = "users")
@EntityListeners(AuditingEntityListener.class)
@Data
@NoArgsConstructor
@AllArgsConstructor
public class User {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(nullable = false, unique = true, length = 50)
    private String username;
    
    @Column(nullable = false, unique = true, length = 100)
    private String email;
    
    @Column(nullable = false)
    private String password;  // BCrypt hashed
    
    @Column(length = 100)
    private String fullName;
    
    @Column(length = 50)
    private String militaryRank;
    
    @Column(nullable = false)
    private Boolean enabled = true;
    
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(
        name = "user_roles",
        joinColumns = @JoinColumn(name = "user_id"),
        inverseJoinColumns = @JoinColumn(name = "role_id")
    )
    private Set<Role> roles = new HashSet<>();
    
    @CreatedDate
    @Column(nullable = false, updatable = false)
    private LocalDateTime createdAt;
    
    @LastModifiedDate
    private LocalDateTime updatedAt;
}
```

**–í–∞–∂–ª–∏–≤–æ:**
- `@ManyToMany(fetch = FetchType.EAGER)` - —Ä–æ–ª—ñ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –≤—ñ–¥—Ä–∞–∑—É
- `password` - –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ BCrypt hash (–ù–ï plaintext!)
- `enabled` - –º–æ–∂–Ω–∞ –¥–µ–∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –±–µ–∑ –≤–∏–¥–∞–ª–µ–Ω–Ω—è

---

### Liquibase changesets –¥–ª—è User/Role

**`005-create-users-roles.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <!-- 1. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–ª–µ–π -->
    <changeSet id="005-create-roles" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ —Ä–æ–ª–µ–π</comment>
        
        <createTable tableName="roles">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(20)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="VARCHAR(200)"/>
        </createTable>
    </changeSet>
    
    <!-- 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
    <changeSet id="005-create-users" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞–±–ª–∏—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</comment>
        
        <createTable tableName="users">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="username" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="email" type="VARCHAR(100)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="full_name" type="VARCHAR(100)"/>
            <column name="military_rank" type="VARCHAR(50)"/>
            <column name="enabled" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>
    
    <!-- 3. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤'—è–∑–∫–æ–≤–æ—ó —Ç–∞–±–ª–∏—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ-—Ä–æ–ª—ñ -->
    <changeSet id="005-create-user-roles" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤'—è–∑–∫–æ–≤–æ—ó —Ç–∞–±–ª–∏—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ-—Ä–æ–ª—ñ</comment>
        
        <createTable tableName="user_roles">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="role_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <addPrimaryKey 
            tableName="user_roles"
            columnNames="user_id, role_id"
            constraintName="pk_user_roles"/>
        
        <addForeignKeyConstraint 
            baseTableName="user_roles"
            baseColumnNames="user_id"
            referencedTableName="users"
            referencedColumnNames="id"
            constraintName="fk_user_roles_user"
            onDelete="CASCADE"/>
        
        <addForeignKeyConstraint 
            baseTableName="user_roles"
            baseColumnNames="role_id"
            referencedTableName="roles"
            referencedColumnNames="id"
            constraintName="fk_user_roles_role"
            onDelete="CASCADE"/>
    </changeSet>
    
    <!-- 4. –î–æ–¥–∞–≤–∞–Ω–Ω—è –±–∞–∑–æ–≤–∏—Ö —Ä–æ–ª–µ–π -->
    <changeSet id="005-insert-default-roles" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–î–æ–¥–∞–≤–∞–Ω–Ω—è –±–∞–∑–æ–≤–∏—Ö —Ä–æ–ª–µ–π</comment>
        
        <insert tableName="roles">
            <column name="name" value="ROLE_ADMIN"/>
            <column name="description" value="–ü–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Å–∏—Å—Ç–µ–º–∏"/>
        </insert>
        
        <insert tableName="roles">
            <column name="name" value="ROLE_OPERATOR"/>
            <column name="description" value="–í–∏–∫–æ–Ω–∞–Ω–Ω—è –æ–ø–µ—Ä–∞—Ü—ñ–π –∑ –º–∞—Ç–µ—Ä—ñ–∞–ª–∞–º–∏"/>
        </insert>
        
        <insert tableName="roles">
            <column name="name" value="ROLE_VIEWER"/>
            <column name="description" value="–¢—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥ –¥–∞–Ω–∏—Ö"/>
        </insert>
    </changeSet>
    
    <!-- 5. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º -->
    <changeSet id="005-insert-default-admin" author="–≤–∞—à–µ-—ñ–º'—è">
        <comment>–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º</comment>
        
        <!-- –ü–∞—Ä–æ–ª—å: admin123 (BCrypt hash) -->
        <insert tableName="users">
            <column name="username" value="admin"/>
            <column name="email" value="admin@viti.edu.ua"/>
            <column name="password" value="$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy"/>
            <column name="full_name" value="System Administrator"/>
            <column name="military_rank" value="–ü–æ–ª–∫–æ–≤–Ω–∏–∫"/>
            <column name="enabled" valueBoolean="true"/>
        </insert>
        
        <!-- –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä–æ–ª—å ADMIN -->
        <sql>
            INSERT INTO user_roles (user_id, role_id)
            SELECT u.id, r.id
            FROM users u, roles r
            WHERE u.username = 'admin' AND r.name = 'ROLE_ADMIN'
        </sql>
    </changeSet>

</databaseChangeLog>
```

**–í–∞–∂–ª–∏–≤–æ:** –ü–∞—Ä–æ–ª—å `admin123` –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - –∑–º—ñ–Ω—ñ—Ç—å –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –≤—Ö–æ–¥—É!

---

### UserRepository —Ç–∞ RoleRepository

```java
package ua.edu.viti.warehouse.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import ua.edu.viti.warehouse.entity.User;

import java.util.Optional;

@Repository
public interface UserRepository extends JpaRepository<User, Long> {
    
    Optional<User> findByUsername(String username);
    
    Optional<User> findByEmail(String email);
    
    boolean existsByUsername(String username);
    
    boolean existsByEmail(String email);
}
```

```java
package ua.edu.viti.warehouse.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import ua.edu.viti.warehouse.entity.Role;
import ua.edu.viti.warehouse.entity.RoleName;

import java.util.Optional;

@Repository
public interface RoleRepository extends JpaRepository<Role, Long> {
    
    Optional<Role> findByName(RoleName name);
}
```

---

### JWT Utility –∫–ª–∞—Å

**–°—Ç–≤–æ—Ä—ñ—Ç—å `JwtUtils.java` –≤ –ø–∞–∫–µ—Ç—ñ `security`:**

```java
package ua.edu.viti.warehouse.security;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.util.Date;

@Component
@Slf4j
public class JwtUtils {
    
    @Value("${app.jwt.secret}")
    private String jwtSecret;
    
    @Value("${app.jwt.expiration-ms}")
    private int jwtExpirationMs;
    
    /**
     * –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è JWT token
     */
    public String generateToken(Authentication authentication) {
        UserDetails userPrincipal = (UserDetails) authentication.getPrincipal();
        
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + jwtExpirationMs);
        
        SecretKey key = Keys.hmacShaKeyFor(jwtSecret.getBytes());
        
        return Jwts.builder()
            .subject(userPrincipal.getUsername())
            .issuedAt(now)
            .expiration(expiryDate)
            .signWith(key)
            .compact();
    }
    
    /**
     * –û—Ç—Ä–∏–º–∞—Ç–∏ username –∑ token
     */
    public String getUsernameFromToken(String token) {
        SecretKey key = Keys.hmacShaKeyFor(jwtSecret.getBytes());
        
        Claims claims = Jwts.parser()
            .verifyWith(key)
            .build()
            .parseSignedClaims(token)
            .getPayload();
        
        return claims.getSubject();
    }
    
    /**
     * –í–∞–ª—ñ–¥–∞—Ü—ñ—è token
     */
    public boolean validateToken(String token) {
        try {
            SecretKey key = Keys.hmacShaKeyFor(jwtSecret.getBytes());
            
            Jwts.parser()
                .verifyWith(key)
                .build()
                .parseSignedClaims(token);
            
            return true;
            
        } catch (MalformedJwtException e) {
            log.error("Invalid JWT token: {}", e.getMessage());
        } catch (ExpiredJwtException e) {
            log.error("JWT token is expired: {}", e.getMessage());
        } catch (UnsupportedJwtException e) {
            log.error("JWT token is unsupported: {}", e.getMessage());
        } catch (IllegalArgumentException e) {
            log.error("JWT claims string is empty: {}", e.getMessage());
        }
        
        return false;
    }
}
```

**–î–æ–¥–∞–π—Ç–µ –≤ `application.properties`:**

```properties
# JWT Configuration
app.jwt.secret=VerySecretKeyThatShouldBeAtLeast256BitsLongForHS256AlgorithmSecurity
app.jwt.expiration-ms=86400000
# 86400000 ms = 24 –≥–æ–¥–∏–Ω–∏
```

**‚ö†Ô∏è –í–ê–ñ–õ–ò–í–û:** `jwt.secret` –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 256 –±—ñ—Ç –¥–ª—è HS256!

---

### UserDetailsService implementation

```java
package ua.edu.viti.warehouse.security;

import lombok.RequiredArgsConstructor;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import ua.edu.viti.warehouse.entity.User;
import ua.edu.viti.warehouse.repository.UserRepository;

import java.util.List;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
public class CustomUserDetailsService implements UserDetailsService {
    
    private final UserRepository userRepository;
    
    @Override
    @Transactional
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException(
                "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: " + username
            ));
        
        List<GrantedAuthority> authorities = user.getRoles().stream()
            .map(role -> new SimpleGrantedAuthority(role.getName().name()))
            .collect(Collectors.toList());
        
        return org.springframework.security.core.userdetails.User
            .builder()
            .username(user.getUsername())
            .password(user.getPassword())
            .authorities(authorities)
            .accountExpired(false)
            .accountLocked(!user.getEnabled())
            .credentialsExpired(false)
            .disabled(!user.getEnabled())
            .build();
    }
}
```

---

### JWT Authentication Filter

```java
package ua.edu.viti.warehouse.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;

@Component
@RequiredArgsConstructor
@Slf4j
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    
    private final JwtUtils jwtUtils;
    private final CustomUserDetailsService userDetailsService;
    
    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain) throws ServletException, IOException {
        
        try {
            // 1. –û—Ç—Ä–∏–º–∞—Ç–∏ JWT –∑ header
            String jwt = getJwtFromRequest(request);
            
            // 2. –Ø–∫—â–æ token —î —Ç–∞ –≤–∞–ª—ñ–¥–Ω–∏–π
            if (StringUtils.hasText(jwt) && jwtUtils.validateToken(jwt)) {
                
                // 3. –û—Ç—Ä–∏–º–∞—Ç–∏ username –∑ token
                String username = jwtUtils.getUsernameFromToken(jwt);
                
                // 4. –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ UserDetails
                UserDetails userDetails = userDetailsService.loadUserByUsername(username);
                
                // 5. –°—Ç–≤–æ—Ä–∏—Ç–∏ Authentication
                UsernamePasswordAuthenticationToken authentication =
                    new UsernamePasswordAuthenticationToken(
                        userDetails,
                        null,
                        userDetails.getAuthorities()
                    );
                
                authentication.setDetails(
                    new WebAuthenticationDetailsSource().buildDetails(request)
                );
                
                // 6. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤ SecurityContext
                SecurityContextHolder.getContext().setAuthentication(authentication);
            }
        } catch (Exception e) {
            log.error("Cannot set user authentication: {}", e.getMessage());
        }
        
        filterChain.doFilter(request, response);
    }
    
    /**
     * –í–∏—Ç—è–≥—Ç–∏ JWT –∑ Authorization header
     */
    private String getJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader("Authorization");
        
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith("Bearer ")) {
            return bearerToken.substring(7);  // –í–∏–¥–∞–ª–∏—Ç–∏ "Bearer " prefix
        }
        
        return null;
    }
}
```

**–Ø–∫ –ø—Ä–∞—Ü—é—î —Ñ—ñ–ª—å—Ç—Ä:**
1. –ü–µ—Ä–µ—Ö–æ–ø–ª—é—î –∫–æ–∂–µ–Ω HTTP –∑–∞–ø–∏—Ç
2. –®—É–∫–∞—î `Authorization: Bearer <token>` header
3. –í–∞–ª—ñ–¥—É—î token
4. –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ –ë–î
5. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î Authentication –≤ SecurityContext
6. –ü—Ä–æ–ø—É—Å–∫–∞—î –∑–∞–ø–∏—Ç –¥–∞–ª—ñ

---

### Security Configuration

```java
package ua.edu.viti.warehouse.config;

import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import ua.edu.viti.warehouse.security.CustomUserDetailsService;
import ua.edu.viti.warehouse.security.JwtAuthenticationFilter;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity  // –î–ª—è @PreAuthorize
@RequiredArgsConstructor
public class SecurityConfig {
    
    private final CustomUserDetailsService userDetailsService;
    private final JwtAuthenticationFilter jwtAuthenticationFilter;
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public DaoAuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(userDetailsService);
        authProvider.setPasswordEncoder(passwordEncoder());
        return authProvider;
    }
    
    @Bean
    public AuthenticationManager authenticationManager(
            AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())  // –í–∏–º–∫–Ω—É—Ç–∏ CSRF –¥–ª—è JWT
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)  // –ë–µ–∑ —Å–µ—Å—ñ–π
            )
            .authorizeHttpRequests(auth -> auth
                // –ü—É–±–ª—ñ—á–Ω—ñ endpoints
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/swagger-ui/**", "/v3/api-docs/**").permitAll()
                
                // GET endpoints - –¥–æ—Å—Ç—É–ø–Ω—ñ –¥–ª—è VIEWER
                .requestMatchers(HttpMethod.GET, "/api/**").hasAnyRole("ADMIN", "OPERATOR", "VIEWER")
                
                // POST/PUT/DELETE - —Ç—ñ–ª—å–∫–∏ ADMIN —Ç–∞ OPERATOR
                .requestMatchers(HttpMethod.POST, "/api/**").hasAnyRole("ADMIN", "OPERATOR")
                .requestMatchers(HttpMethod.PUT, "/api/**").hasAnyRole("ADMIN", "OPERATOR")
                .requestMatchers(HttpMethod.DELETE, "/api/**").hasRole("ADMIN")
                
                // –í—Å—ñ —ñ–Ω—à—ñ - —Ç—ñ–ª—å–∫–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ
                .anyRequest().authenticated()
            )
            .authenticationProvider(authenticationProvider())
            .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
}
```

**–í–∞–∂–ª–∏–≤—ñ –º–æ–º–µ–Ω—Ç–∏:**
- `SessionCreationPolicy.STATELESS` - –±–µ–∑ HTTP session (JWT stateless)
- `.csrf().disable()` - CSRF –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è JWT
- `.permitAll()` - –±–µ–∑ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
- `.hasRole("ADMIN")` - —Ç—ñ–ª—å–∫–∏ ADMIN
- `.hasAnyRole("ADMIN", "OPERATOR")` - ADMIN –∞–±–æ OPERATOR

---

### Auth DTO

**LoginRequestDTO:**

```java
package ua.edu.viti.warehouse.dto.request;

import jakarta.validation.constraints.NotBlank;
import lombok.Data;

@Data
public class LoginRequestDTO {
    
    @NotBlank(message = "Username –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π")
    private String username;
    
    @NotBlank(message = "–ü–∞—Ä–æ–ª—å –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π")
    private String password;
}
```

**RegisterRequestDTO:**

```java
package ua.edu.viti.warehouse.dto.request;

import jakarta.validation.constraints.*;
import lombok.Data;

import java.util.Set;

@Data
public class RegisterRequestDTO {
    
    @NotBlank(message = "Username –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π")
    @Size(min = 3, max = 50)
    private String username;
    
    @NotBlank(message = "Email –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π")
    @Email(message = "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π email")
    private String email;
    
    @NotBlank(message = "–ü–∞—Ä–æ–ª—å –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π")
    @Size(min = 6, message = "–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤")
    private String password;
    
    @NotBlank
    @Size(max = 100)
    private String fullName;
    
    @Size(max = 50)
    private String militaryRank;
    
    private Set<String> roles;  // –ù–∞–∑–≤–∏ —Ä–æ–ª–µ–π: ["ROLE_OPERATOR"]
}
```

**JwtResponseDTO:**

```java
package ua.edu.viti.warehouse.dto.response;

import lombok.AllArgsConstructor;
import lombok.Data;

import java.util.List;

@Data
@AllArgsConstructor
public class JwtResponseDTO {
    private String token;
    private String type = "Bearer";
    private String username;
    private String email;
    private List<String> roles;
    
    public JwtResponseDTO(String token, String username, String email, List<String> roles) {
        this.token = token;
        this.username = username;
        this.email = email;
        this.roles = roles;
    }
}
```

---

### AuthService

```java
package ua.edu.viti.warehouse.service;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import ua.edu.viti.warehouse.dto.request.LoginRequestDTO;
import ua.edu.viti.warehouse.dto.request.RegisterRequestDTO;
import ua.edu.viti.warehouse.dto.response.JwtResponseDTO;
import ua.edu.viti.warehouse.entity.Role;
import ua.edu.viti.warehouse.entity.RoleName;
import ua.edu.viti.warehouse.entity.User;
import ua.edu.viti.warehouse.exception.DuplicateResourceException;
import ua.edu.viti.warehouse.exception.ResourceNotFoundException;
import ua.edu.viti.warehouse.repository.RoleRepository;
import ua.edu.viti.warehouse.repository.UserRepository;
import ua.edu.viti.warehouse.security.JwtUtils;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Service
@RequiredArgsConstructor
@Slf4j
public class AuthService {
    
    private final UserRepository userRepository;
    private final RoleRepository roleRepository;
    private final PasswordEncoder passwordEncoder;
    private final AuthenticationManager authenticationManager;
    private final JwtUtils jwtUtils;
    
    /**
     * Login –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
     */
    public JwtResponseDTO login(LoginRequestDTO dto) {
        log.info("User login attempt: {}", dto.getUsername());
        
        // 1. –ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è
        Authentication authentication = authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(
                dto.getUsername(),
                dto.getPassword()
            )
        );
        
        // 2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤ SecurityContext
        SecurityContextHolder.getContext().setAuthentication(authentication);
        
        // 3. –ì–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ JWT token
        String jwt = jwtUtils.generateToken(authentication);
        
        // 4. –û—Ç—Ä–∏–º–∞—Ç–∏ UserDetails
        UserDetails userDetails = (UserDetails) authentication.getPrincipal();
        List<String> roles = userDetails.getAuthorities().stream()
            .map(GrantedAuthority::getAuthority)
            .toList();
        
        // 5. –û—Ç—Ä–∏–º–∞—Ç–∏ email
        User user = userRepository.findByUsername(userDetails.getUsername())
            .orElseThrow(() -> new ResourceNotFoundException("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"));
        
        log.info("User logged in successfully: {}", dto.getUsername());
        
        return new JwtResponseDTO(
            jwt,
            userDetails.getUsername(),
            user.getEmail(),
            roles
        );
    }
    
    /**
     * –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
     */
    @Transactional
    public String register(RegisterRequestDTO dto) {
        log.info("User registration attempt: {}", dto.getUsername());
        
        // 1. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –Ω–µ —ñ—Å–Ω—É—î
        if (userRepository.existsByUsername(dto.getUsername())) {
            throw new DuplicateResourceException("Username –≤–∂–µ –∑–∞–π–Ω—è—Ç–∏–π");
        }
        
        if (userRepository.existsByEmail(dto.getEmail())) {
            throw new DuplicateResourceException("Email –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏–π");
        }
        
        // 2. –°—Ç–≤–æ—Ä–∏—Ç–∏ User
        User user = new User();
        user.setUsername(dto.getUsername());
        user.setEmail(dto.getEmail());
        user.setPassword(passwordEncoder.encode(dto.getPassword()));  // Hash password
        user.setFullName(dto.getFullName());
        user.setMilitaryRank(dto.getMilitaryRank());
        user.setEnabled(true);
        
        // 3. –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä–æ–ª—ñ
        Set<Role> roles = new HashSet<>();
        
        if (dto.getRoles() == null || dto.getRoles().isEmpty()) {
            // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - VIEWER
            Role viewerRole = roleRepository.findByName(RoleName.ROLE_VIEWER)
                .orElseThrow(() -> new ResourceNotFoundException("–†–æ–ª—å VIEWER –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"));
            roles.add(viewerRole);
        } else {
            // –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ –≤–∫–∞–∑–∞–Ω—ñ —Ä–æ–ª—ñ
            for (String roleName : dto.getRoles()) {
                try {
                    RoleName roleEnum = RoleName.valueOf(roleName);
                    Role role = roleRepository.findByName(roleEnum)
                        .orElseThrow(() -> new ResourceNotFoundException("–†–æ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: " + roleName));
                    roles.add(role);
                } catch (IllegalArgumentException e) {
                    log.warn("Invalid role name: {}", roleName);
                }
            }
        }
        
        user.setRoles(roles);
        
        // 4. –ó–±–µ—Ä–µ–≥—Ç–∏
        userRepository.save(user);
        
        log.info("User registered successfully: {}", dto.getUsername());
        
        return "–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ";
    }
}
```

---

### AuthController

```java
package ua.edu.viti.warehouse.controller;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import ua.edu.viti.warehouse.dto.request.LoginRequestDTO;
import ua.edu.viti.warehouse.dto.request.RegisterRequestDTO;
import ua.edu.viti.warehouse.dto.response.JwtResponseDTO;
import ua.edu.viti.warehouse.service.AuthService;

@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
@Slf4j
@Tag(name = "Authentication", description = "API –¥–ª—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó")
public class AuthController {
    
    private final AuthService authService;
    
    @PostMapping("/login")
    @Operation(summary = "–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É", description = "–ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è JWT token")
    public ResponseEntity<JwtResponseDTO> login(@Valid @RequestBody LoginRequestDTO dto) {
        JwtResponseDTO response = authService.login(dto);
        return ResponseEntity.ok(response);
    }
    
    @PostMapping("/register")
    @Operation(summary = "–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è", description = "–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞")
    public ResponseEntity<String> register(@Valid @RequestBody RegisterRequestDTO dto) {
        String message = authService.register(dto);
        return ResponseEntity.status(HttpStatus.CREATED).body(message);
    }
}
```

---

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è @PreAuthorize

**–í MovementController:**

```java
@RestController
@RequestMapping("/api/movements")
@RequiredArgsConstructor
@Slf4j
@Tag(name = "Supply Movements")
public class SupplyMovementController {
    
    private final SupplyMovementService movementService;
    
    @PostMapping("/issue")
    @PreAuthorize("hasAnyRole('ADMIN', 'OPERATOR')")  // –¢—ñ–ª—å–∫–∏ ADMIN –∞–±–æ OPERATOR
    @Operation(summary = "–í–∏–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏")
    public ResponseEntity<MovementResponseDTO> issueItem(@Valid @RequestBody MovementRequestDTO dto) {
        MovementResponseDTO movement = movementService.issueItem(dto);
        return ResponseEntity.status(HttpStatus.CREATED).body(movement);
    }
    
    @PostMapping("/write-off")
    @PreAuthorize("hasRole('ADMIN')")  // –¢—ñ–ª—å–∫–∏ ADMIN
    @Operation(summary = "–°–ø–∏—Å–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª–∏")
    public ResponseEntity<MovementResponseDTO> writeOffItem(@Valid @RequestBody MovementRequestDTO dto) {
        MovementResponseDTO movement = movementService.writeOffItem(dto);
        return ResponseEntity.status(HttpStatus.CREATED).body(movement);
    }
    
    @GetMapping("/item/{itemId}")
    @PreAuthorize("hasAnyRole('ADMIN', 'OPERATOR', 'VIEWER')")  // –í—Å—ñ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ñ
    @Operation(summary = "–Ü—Å—Ç–æ—Ä—ñ—è –æ–ø–µ—Ä–∞—Ü—ñ–π")
    public ResponseEntity<List<MovementResponseDTO>> getItemHistory(@PathVariable Long itemId) {
        List<MovementResponseDTO> history = movementService.getItemHistory(itemId);
        return ResponseEntity.ok(history);
    }
}
```

---

### –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è JWT

**1. –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:**

```json
POST /api/auth/register
Content-Type: application/json

{
  "username": "operator1",
  "email": "operator1@viti.edu.ua",
  "password": "password123",
  "fullName": "–ü–µ—Ç—Ä–µ–Ω–∫–æ –ü–µ—Ç—Ä–æ –ü–µ—Ç—Ä–æ–≤–∏—á",
  "militaryRank": "–°—Ç–∞—Ä—à–∏–π –ª–µ–π—Ç–µ–Ω–∞–Ω—Ç",
  "roles": ["ROLE_OPERATOR"]
}
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
HTTP/1.1 201 Created
"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ —É—Å–ø—ñ—à–Ω–æ"
```

---

**2. –õ–æ–≥—ñ–Ω:**

```json
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

**–í—ñ–¥–ø–æ–≤—ñ–¥—å:**
```json
HTTP/1.1 200 OK
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "type": "Bearer",
  "username": "admin",
  "email": "admin@viti.edu.ua",
  "roles": ["ROLE_ADMIN"]
}
```

**–ó–±–µ—Ä–µ–∂—ñ—Ç—å token!**

---

**3. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è token –≤ –∑–∞–ø–∏—Ç–∞—Ö:**

```json
GET /api/supply-items
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**–ë–µ–∑ token:**
```json
HTTP/1.1 403 Forbidden
{
  "timestamp": "2024-12-01T15:30:00",
  "status": 403,
  "error": "Forbidden",
  "message": "Access Denied",
  "path": "/api/supply-items"
}
```

---

**4. –°–ø—Ä–æ–±–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ —è–∫ VIEWER (–º–∞—î –±—É—Ç–∏ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ):**

```json
DELETE /api/supply-items/1
Authorization: Bearer <VIEWER_TOKEN>

HTTP/1.1 403 Forbidden
```

---

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ Service

**–û–Ω–æ–≤—ñ—Ç—å MovementService:**

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SupplyMovementService {
    
    // ...
    
    private String getCurrentUser() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        
        if (authentication != null && authentication.isAuthenticated()) {
            return authentication.getName();  // username
        }
        
        return "system";
    }
}
```

–¢–µ–ø–µ—Ä –≤ MovementLog –±—É–¥–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è —Ä–µ–∞–ª—å–Ω–∏–π username!

---

## üó∫Ô∏è –ï–¢–ê–ü 4: MAPSTRUCT (45 —Ö–≤)

### –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω MapStruct?

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø—ñ–Ω–≥—É:**

```java
// ‚ùå –í–†–£–ß–ù–£ - –±–∞–≥–∞—Ç–æ –∫–æ–¥—É, –ø–æ–º–∏–ª–∫–∏, –Ω–µ–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—ñ–¥—Ç—Ä–∏–º–∫–∏
private ItemResponseDTO toResponseDTO(SupplyItem entity) {
    ItemResponseDTO dto = new ItemResponseDTO();
    dto.setId(entity.getId());
    dto.setName(entity.getName());
    dto.setBatchNumber(entity.getBatchNumber());
    
    CategoryResponseDTO categoryDTO = new CategoryResponseDTO();
    categoryDTO.setId(entity.getCategory().getId());
    categoryDTO.setName(entity.getCategory().getName());
    // ... —â–µ 20 —Ä—è–¥–∫—ñ–≤
    
    dto.setCategory(categoryDTO);
    // ... —â–µ 10 —Ä—è–¥–∫—ñ–≤
    
    return dto;
}
```

**–†—ñ—à–µ–Ω–Ω—è - MapStruct:**

```java
// ‚úÖ –ê–í–¢–û–ú–ê–¢–ò–ß–ù–û - –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –∫–æ–¥ –∫–æ–º–ø—ñ–ª—è—Ç–æ—Ä–æ–º
@Mapper(componentModel = "spring")
public interface ItemMapper {
    ItemResponseDTO toResponseDTO(SupplyItem entity);
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ –ú—ñ–Ω—ñ–º—É–º –∫–æ–¥—É
- ‚úÖ Compile-time –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ (–ø–æ–º–∏–ª–∫–∏ –Ω–∞ –µ—Ç–∞–ø—ñ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó)
- ‚úÖ –®–≤–∏–¥–∫—ñ—Å—Ç—å (–±–µ–∑ Reflection)
- ‚úÖ –õ–µ–≥–∫–æ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏

---

### –î–æ–¥–∞–≤–∞–Ω–Ω—è MapStruct

**–£ `pom.xml`:**

```xml
<properties>
    <org.mapstruct.version>1.5.5.Final</org.mapstruct.version>
    <lombok-mapstruct-binding.version>0.2.0</lombok-mapstruct-binding.version>
</properties>

<dependencies>
    <!-- MapStruct -->
    <dependency>
        <groupId>org.mapstruct</groupId>
        <artifactId>mapstruct</artifactId>
        <version>${org.mapstruct.version}</version>
    </dependency>
</dependencies>

<build>
    <plugins>
        <plugin>
            <groupId>org.apache.maven.plugins</groupId>
            <artifactId>maven-compiler-plugin</artifactId>
            <version>3.11.0</version>
            <configuration>
                <source>17</source>
                <target>17</target>
                <annotationProcessorPaths>
                    <!-- Lombok -->
                    <path>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok</artifactId>
                        <version>${lombok.version}</version>
                    </path>
                    <!-- MapStruct -->
                    <path>
                        <groupId>org.mapstruct</groupId>
                        <artifactId>mapstruct-processor</artifactId>
                        <version>${org.mapstruct.version}</version>
                    </path>
                    <!-- Lombok + MapStruct binding -->
                    <path>
                        <groupId>org.projectlombok</groupId>
                        <artifactId>lombok-mapstruct-binding</artifactId>
                        <version>${lombok-mapstruct-binding.version}</version>
                    </path>
                </annotationProcessorPaths>
            </configuration>
        </plugin>
    </plugins>
</build>
```

**–ö–æ–º–ø—ñ–ª—è—Ü—ñ—è:**
```bash
mvn clean compile
```

---

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Mapper —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ñ–≤

**–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–∞–∫–µ—Ç `mapper`**

**CategoryMapper:**

```java
package ua.edu.viti.warehouse.mapper;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.MappingTarget;
import ua.edu.viti.warehouse.dto.request.SupplyCategoryCreateDTO;
import ua.edu.viti.warehouse.dto.response.SupplyCategoryResponseDTO;
import ua.edu.viti.warehouse.entity.SupplyCategory;

import java.util.List;

@Mapper(componentModel = "spring")
public interface SupplyCategoryMapper {
    
    // Entity ‚Üí ResponseDTO
    SupplyCategoryResponseDTO toResponseDTO(SupplyCategory entity);
    
    // List<Entity> ‚Üí List<ResponseDTO>
    List<SupplyCategoryResponseDTO> toResponseDTOList(List<SupplyCategory> entities);
    
    // CreateDTO ‚Üí Entity
    SupplyCategory toEntity(SupplyCategoryCreateDTO dto);
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ Entity –∑ DTO
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    void updateEntityFromDTO(SupplyCategoryCreateDTO dto, @MappingTarget SupplyCategory entity);
}
```

**–Ø–∫ –ø—Ä–∞—Ü—é—î:**
- `@Mapper(componentModel = "spring")` - —Å—Ç–≤–æ—Ä–∏—Ç–∏ Spring Bean
- MapStruct –≥–µ–Ω–µ—Ä—É—î implementation –ø—Ä–∏ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º–∞–ø–ø–∏—Ç—å –ø–æ–ª—è –∑ –æ–¥–Ω–∞–∫–æ–≤–∏–º–∏ —ñ–º–µ–Ω–∞–º–∏
- `@Mapping(target = "...", ignore = true)` - –Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —Ü–µ –ø–æ–ª–µ

---

**ItemMapper (—Å–∫–ª–∞–¥–Ω—ñ—à–∏–π –∑ –≤–∫–ª–∞–¥–µ–Ω–∏–º–∏ –æ–±'—î–∫—Ç–∞–º–∏):**

```java
package ua.edu.viti.warehouse.mapper;

import org.mapstruct.*;
import ua.edu.viti.warehouse.dto.request.SupplyItemCreateDTO;
import ua.edu.viti.warehouse.dto.request.SupplyItemUpdateDTO;
import ua.edu.viti.warehouse.dto.response.SupplyItemResponseDTO;
import ua.edu.viti.warehouse.entity.SupplyCategory;
import ua.edu.viti.warehouse.entity.SupplyItem;
import ua.edu.viti.warehouse.entity.Warehouse;

import java.util.List;

@Mapper(componentModel = "spring", uses = {SupplyCategoryMapper.class})
public interface SupplyItemMapper {
    
    // Entity ‚Üí ResponseDTO
    @Mapping(source = "category", target = "category")  // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î CategoryMapper
    @Mapping(source = "warehouse.id", target = "warehouseId")
    @Mapping(source = "warehouse.name", target = "warehouseName")
    SupplyItemResponseDTO toResponseDTO(SupplyItem entity);
    
    // List
    List<SupplyItemResponseDTO> toResponseDTOList(List<SupplyItem> entities);
    
    // CreateDTO ‚Üí Entity (—Å–∫–ª–∞–¥–Ω—ñ—à–µ - —Ç—Ä–µ–±–∞ —Ä–æ–∑–≤'—è–∑–∞—Ç–∏ categoryId)
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "category", ignore = true)  // –í—Å—Ç–∞–Ω–æ–≤–∏–º–æ –≤—Ä—É—á–Ω—É –≤ Service
    @Mapping(target = "warehouse", ignore = true)
    @Mapping(target = "status", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    SupplyItem toEntity(SupplyItemCreateDTO dto);
    
    // UpdateDTO ‚Üí Entity
    @Mapping(target = "id", ignore = true)
    @Mapping(target = "batchNumber", ignore = true)  // –ù–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏
    @Mapping(target = "category", ignore = true)
    @Mapping(target = "warehouse", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    @BeanMapping(nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE)
    void updateEntityFromDTO(SupplyItemUpdateDTO dto, @MappingTarget SupplyItem entity);
}
```

**–í–∞–∂–ª–∏–≤—ñ –∞–Ω–æ—Ç–∞—Ü—ñ—ó:**
- `uses = {CategoryMapper.class}` - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —ñ–Ω—à–∏–π mapper –¥–ª—è –≤–∫–ª–∞–¥–µ–Ω–∏—Ö –æ–±'—î–∫—Ç—ñ–≤
- `@Mapping(source = "warehouse.id", target = "warehouseId")` - nested property mapping
- `@BeanMapping(nullValuePropertyMappingStrategy = IGNORE)` - –Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ —è–∫—â–æ DTO –ø–æ–ª–µ null

---

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Mappers –≤ Service

**–û–Ω–æ–≤–ª–µ–Ω–∏–π ItemService:**

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class SupplyItemService {
    
    private final SupplyItemRepository itemRepository;
    private final SupplyCategoryRepository categoryRepository;
    private final WarehouseRepository warehouseRepository;
    private final SupplyItemMapper itemMapper;  // ‚Üê Inject mapper
    
    @Transactional
    public SupplyItemResponseDTO create(SupplyItemCreateDTO dto) {
        log.info("Creating new supply item with batch number: {}", dto.getBatchNumber());
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ
        if (itemRepository.existsByBatchNumber(dto.getBatchNumber())) {
            throw new DuplicateResourceException("Batch number already exists");
        }
        
        // –ó–Ω–∞–π—Ç–∏ Category
        SupplyCategory category = categoryRepository.findById(dto.getCategoryId())
            .orElseThrow(() -> new ResourceNotFoundException("Category not found"));
        
        // –ó–Ω–∞–π—Ç–∏ Warehouse (—è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ)
        Warehouse warehouse = null;
        if (dto.getWarehouseId() != null) {
            warehouse = warehouseRepository.findById(dto.getWarehouseId())
                .orElseThrow(() -> new ResourceNotFoundException("Warehouse not found"));
        }
        
        // –ú–∞–ø–ø—ñ–Ω–≥ DTO ‚Üí Entity —á–µ—Ä–µ–∑ MapStruct
        SupplyItem item = itemMapper.toEntity(dto);
        
        // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–æ–ª—è —â–æ –Ω–µ –º–∞–ø–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
        item.setCategory(category);
        item.setWarehouse(warehouse);
        item.setStatus(ItemStatus.IN_STOCK);
        
        // –ó–±–µ—Ä–µ–≥—Ç–∏
        SupplyItem saved = itemRepository.save(item);
        
        // –ú–∞–ø–ø—ñ–Ω–≥ Entity ‚Üí ResponseDTO —á–µ—Ä–µ–∑ MapStruct
        return itemMapper.toResponseDTO(saved);
    }
    
    public SupplyItemResponseDTO getById(Long id) {
        SupplyItem item = itemRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Item not found"));
        
        return itemMapper.toResponseDTO(item);  // ‚Üê –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ mapper
    }
    
    public List<SupplyItemResponseDTO> getAll(ItemStatus status, Long categoryId) {
        List<SupplyItem> items;
        
        if (status != null && categoryId != null) {
            items = itemRepository.findByStatusAndCategoryId(status, categoryId);
        } else if (status != null) {
            items = itemRepository.findByStatus(status);
        } else if (categoryId != null) {
            items = itemRepository.findByCategoryId(categoryId);
        } else {
            items = itemRepository.findAll();
        }
        
        return itemMapper.toResponseDTOList(items);  // ‚Üê –°–ø–∏—Å–æ–∫
    }
    
    @Transactional
    public SupplyItemResponseDTO update(Long id, SupplyItemUpdateDTO dto) {
        SupplyItem item = itemRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Item not found"));
        
        // –û–Ω–æ–≤–∏—Ç–∏ —á–µ—Ä–µ–∑ MapStruct (—Ç—ñ–ª—å–∫–∏ non-null –ø–æ–ª—è)
        itemMapper.updateEntityFromDTO(dto, item);
        
        // –Ø–∫—â–æ —Ç—Ä–µ–±–∞ –∑–º—ñ–Ω–∏—Ç–∏ warehouse
        if (dto.getWarehouseId() != null) {
            Warehouse warehouse = warehouseRepository.findById(dto.getWarehouseId())
                .orElseThrow(() -> new ResourceNotFoundException("Warehouse not found"));
            item.setWarehouse(warehouse);
        }
        
        SupplyItem updated = itemRepository.save(item);
        
        return itemMapper.toResponseDTO(updated);
    }
    
    // delete –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ –ú–µ–Ω—à–µ –∫–æ–¥—É
- ‚úÖ –ù–µ–º–∞—î —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø—ñ–Ω–≥—É
- ‚úÖ Compile-time –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
- ‚úÖ –õ–µ–≥—à–µ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏

---

### Custom Mappings (—Ä–æ–∑—à–∏—Ä–µ–Ω–∞ —Ç–µ–º–∞)

**–Ø–∫—â–æ —Ç—Ä–µ–±–∞ —Å–∫–ª–∞–¥–Ω–∞ –ª–æ–≥—ñ–∫–∞ –º–∞–ø–ø—ñ–Ω–≥—É:**

```java
@Mapper(componentModel = "spring")
public interface ItemMapper {
    
    @Mapping(target = "statusDisplay", expression = "java(formatStatus(entity.getStatus()))")
    @Mapping(target = "daysUntilExpiration", expression = "java(calculateDaysUntilExpiration(entity.getExpirationDate()))")
    ItemResponseDTO toResponseDTO(SupplyItem entity);
    
    // Custom –º–µ—Ç–æ–¥–∏
    default String formatStatus(ItemStatus status) {
        return switch (status) {
            case IN_STOCK -> "–ù–∞ —Å–∫–ª–∞–¥—ñ";
            case ISSUED -> "–í–∏–¥–∞–Ω–æ";
            case EXPIRED -> "–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ";
            case WRITTEN_OFF -> "–°–ø–∏—Å–∞–Ω–æ";
        };
    }
    
    default Integer calculateDaysUntilExpiration(LocalDate expirationDate) {
        if (expirationDate == null) {
            return null;
        }
        return (int) ChronoUnit.DAYS.between(LocalDate.now(), expirationDate);
    }
}
```

---

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ–≥–æ –∫–æ–¥—É

**–ü—ñ—Å–ª—è –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó:**

```bash
mvn clean compile
```

**–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏:**
```
target/generated-sources/annotations/
‚îî‚îÄ‚îÄ ua/edu/viti/warehouse/mapper/
    ‚îú‚îÄ‚îÄ SupplyCategoryMapperImpl.java
    ‚îî‚îÄ‚îÄ SupplyItemMapperImpl.java
```

**–ü—Ä–∏–∫–ª–∞–¥ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ–≥–æ –∫–æ–¥—É (CategoryMapperImpl):**

```java
@Component
public class SupplyCategoryMapperImpl implements SupplyCategoryMapper {

    @Override
    public SupplyCategoryResponseDTO toResponseDTO(SupplyCategory entity) {
        if (entity == null) {
            return null;
        }

        SupplyCategoryResponseDTO dto = new SupplyCategoryResponseDTO();
        
        dto.setId(entity.getId());
        dto.setName(entity.getName());
        dto.setCode(entity.getCode());
        dto.setDescription(entity.getDescription());
        dto.setRequiresColdStorage(entity.getRequiresColdStorage());
        dto.setCreatedAt(entity.getCreatedAt());
        dto.setUpdatedAt(entity.getUpdatedAt());

        return dto;
    }
    
    // ... —ñ–Ω—à—ñ –º–µ—Ç–æ–¥–∏
}
```

**–¶–µ Spring Bean** - –º–æ–∂–Ω–∞ —ñ–Ω–∂–µ–∫—Ç–∏—Ç–∏ –≤ Service!

---

## üì¶ –ï–¢–ê–ü 5: REDIS CACHING (45 —Ö–≤)

### –ù–∞–≤—ñ—â–æ –∫–µ—à—É–≤–∞–Ω–Ω—è?

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ –∫–µ—à—É:**

```
–ó–∞–ø–∏—Ç ‚Üí Service ‚Üí Repository ‚Üí –ë–î ‚Üí Result
       1ms        5ms          50ms    56ms –∑–∞–≥–∞–ª–æ–º
```

**–ó –∫–µ—à–µ–º (–ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ –∑–∞–ø–∏—Ç—É):**

```
–ó–∞–ø–∏—Ç ‚Üí Service ‚Üí Redis Cache ‚Üí Result
       1ms        2ms            3ms –∑–∞–≥–∞–ª–æ–º (18x —à–≤–∏–¥—à–µ!)
```

**–©–æ –∫–µ—à—É–≤–∞—Ç–∏:**
- ‚úÖ –î–∞–Ω—ñ —â–æ —á–∞—Å—Ç–æ —á–∏—Ç–∞—é—Ç—å—Å—è (categories, warehouses)
- ‚úÖ –î–∞–Ω—ñ —â–æ —Ä—ñ–¥–∫–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è
- ‚úÖ –í–∞–∂–∫—ñ –∑–∞–ø–∏—Ç–∏ –∑ JOIN
- ‚ùå –î–∞–Ω—ñ —â–æ —á–∞—Å—Ç–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è (items quantity)

---

### –î–æ–¥–∞–≤–∞–Ω–Ω—è Redis

**1. –î–æ–¥–∞–π—Ç–µ –≤ `docker-compose.yml`:**

```yaml
services:
  postgres:
    # ... —ñ—Å–Ω—É—é—á–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
  
  redis:
    image: redis:7-alpine
    container_name: military-warehouse-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - warehouse-network

volumes:
  postgres-data:
  redis-data:  # –ù–æ–≤–∏–π volume

networks:
  warehouse-network:
```

**2. –ó–∞–ø—É—Å—Ç—ñ—Ç—å Redis:**

```bash
docker-compose up -d redis

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
docker-compose ps
# redis   redis:7-alpine   Up   6379->6379
```

---

**3. –î–æ–¥–∞–π—Ç–µ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å –≤ `pom.xml`:**

```xml
<!-- Spring Data Redis -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-cache</artifactId>
</dependency>
```

---

**4. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è `application.properties`:**

```properties
# Redis Configuration
spring.data.redis.host=localhost
spring.data.redis.port=6379
spring.data.redis.timeout=60000

# Cache Configuration
spring.cache.type=redis
spring.cache.redis.time-to-live=3600000
# TTL = 1 –≥–æ–¥–∏–Ω–∞ (3600000 ms)
```

---

### Cache Configuration

**–°—Ç–≤–æ—Ä—ñ—Ç—å `CacheConfig.java`:**

```java
package ua.edu.viti.warehouse.config;

import org.springframework.cache.CacheManager;
import org.springframework.cache.annotation.EnableCaching;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.cache.RedisCacheConfiguration;
import org.springframework.data.redis.cache.RedisCacheManager;
import org.springframework.data.redis.connection.RedisConnectionFactory;
import org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;
import org.springframework.data.redis.serializer.RedisSerializationContext;
import org.springframework.data.redis.serializer.StringRedisSerializer;

import java.time.Duration;
import java.util.HashMap;
import java.util.Map;

@Configuration
@EnableCaching  // ‚Üê –í–∞–∂–ª–∏–≤–æ!
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager(RedisConnectionFactory connectionFactory) {
        
        // –ë–∞–∑–æ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 1 –≥–æ–¥–∏–Ω–∞)
        RedisCacheConfiguration defaultConfig = RedisCacheConfiguration
            .defaultCacheConfig()
            .entryTtl(Duration.ofHours(1))
            .serializeKeysWith(
                RedisSerializationContext.SerializationPair.fromSerializer(
                    new StringRedisSerializer()
                )
            )
            .serializeValuesWith(
                RedisSerializationContext.SerializationPair.fromSerializer(
                    new GenericJackson2JsonRedisSerializer()
                )
            );
        
        // –°–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –∫–µ—à—ñ–≤
        Map<String, RedisCacheConfiguration> cacheConfigurations = new HashMap<>();
        
        // –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó - –∫–µ—à—É—î–º–æ –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏ (—Ä—ñ–¥–∫–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è)
        cacheConfigurations.put("categories", defaultConfig.entryTtl(Duration.ofHours(24)));
        
        // –°–∫–ª–∞–¥–∏ - –∫–µ—à—É—î–º–æ –Ω–∞ 12 –≥–æ–¥–∏–Ω
        cacheConfigurations.put("warehouses", defaultConfig.entryTtl(Duration.ofHours(12)));
        
        // Items - –∫–µ—à—É—î–º–æ –Ω–∞ 30 —Ö–≤–∏–ª–∏–Ω (—á–∞—Å—Ç–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è)
        cacheConfigurations.put("items", defaultConfig.entryTtl(Duration.ofMinutes(30)));
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –∫–µ—à—É—î–º–æ –Ω–∞ 5 —Ö–≤–∏–ª–∏–Ω
        cacheConfigurations.put("statistics", defaultConfig.entryTtl(Duration.ofMinutes(5)));
        
        return RedisCacheManager.builder(connectionFactory)
            .cacheDefaults(defaultConfig)
            .withInitialCacheConfigurations(cacheConfigurations)
            .build();
    }
}
```

---

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–µ—à—É –≤ Service

**CategoryService –∑ –∫–µ—à—É–≤–∞–Ω–Ω—è–º:**

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class SupplyCategoryService {
    
    private final SupplyCategoryRepository categoryRepository;
    private final SupplyCategoryMapper categoryMapper;
    
    /**
     * –ö–µ—à—É–≤–∞–Ω–Ω—è - —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ Redis
     * –ö–ª—é—á: categories::1 (–¥–µ 1 - —Ü–µ id)
     */
    @Cacheable(value = "categories", key = "#id")
    public SupplyCategoryResponseDTO getById(Long id) {
        log.info("Fetching category from database: id={}", id);  // –õ–æ–≥—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ cache miss
        
        SupplyCategory category = categoryRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Category not found"));
        
        return categoryMapper.toResponseDTO(category);
    }
    
    /**
     * –ö–µ—à—É–≤–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É
     * –ö–ª—é—á: categories::all
     */
    @Cacheable(value = "categories", key = "'all'")
    public List<SupplyCategoryResponseDTO> getAll() {
        log.info("Fetching all categories from database");
        
        List<SupplyCategory> categories = categoryRepository.findAll();
        return categoryMapper.toResponseDTOList(categories);
    }
    
    /**
     * –ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ - invalidate –∫–µ—à —Å–ø–∏—Å–∫—É
     */
    @Transactional
    @CacheEvict(value = "categories", key = "'all'")
    public SupplyCategoryResponseDTO create(SupplyCategoryCreateDTO dto) {
        log.info("Creating new category: {}", dto.getName());
        
        if (categoryRepository.existsByCode(dto.getCode())) {
            throw new DuplicateResourceException("Code already exists");
        }
        
        SupplyCategory category = categoryMapper.toEntity(dto);
        SupplyCategory saved = categoryRepository.save(category);
        
        return categoryMapper.toResponseDTO(saved);
    }
    
    /**
     * –ü—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ - invalidate –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –∑–∞–ø–∏—Å —Ç–∞ —Å–ø–∏—Å–æ–∫
     */
    @Transactional
    @CacheEvict(value = "categories", key = "#id")
    @CacheEvict(value = "categories", key = "'all'")
    public SupplyCategoryResponseDTO update(Long id, SupplyCategoryCreateDTO dto) {
        log.info("Updating category: id={}", id);
        
        SupplyCategory category = categoryRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Category not found"));
        
        categoryMapper.updateEntityFromDTO(dto, category);
        SupplyCategory updated = categoryRepository.save(category);
        
        return categoryMapper.toResponseDTO(updated);
    }
    
    /**
     * –ü—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ - invalidate –∫–µ—à
     */
    @Transactional
    @CacheEvict(value = "categories", allEntries = true)  // –í–∏–¥–∞–ª–∏—Ç–∏ –≤–µ—Å—å –∫–µ—à categories
    public void delete(Long id) {
        log.info("Deleting category: id={}", id);
        
        if (!categoryRepository.existsById(id)) {
            throw new ResourceNotFoundException("Category not found");
        }
        
        categoryRepository.deleteById(id);
    }
}
```

**–ê–Ω–æ—Ç–∞—Ü—ñ—ó –∫–µ—à—É–≤–∞–Ω–Ω—è:**
- `@Cacheable` - –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–µ—à—ñ, –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∑–∞–ø–∏—Ç—ñ - –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –∑ –∫–µ—à—É
- `@CacheEvict` - –≤–∏–¥–∞–ª–∏—Ç–∏ –∑ –∫–µ—à—É (invalidation)
- `@CachePut` - –∑–∞–≤–∂–¥–∏ –≤–∏–∫–æ–Ω–∞—Ç–∏ –º–µ—Ç–æ–¥ —Ç–∞ –æ–Ω–æ–≤–∏—Ç–∏ –∫–µ—à
- `@Caching` - –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—è –¥–µ–∫—ñ–ª—å–∫–æ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π

---

### –°–∫–ª–∞–¥–Ω—ñ—à—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –∫–µ—à—É–≤–∞–Ω–Ω—è

**ItemService (–≤–∏–±—ñ—Ä–∫–æ–≤–µ –∫–µ—à—É–≤–∞–Ω–Ω—è):**

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class SupplyItemService {
    
    private final SupplyItemRepository itemRepository;
    private final SupplyItemMapper itemMapper;
    
    /**
     * –ö–µ—à—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Å—Ç–∞—Ç—É—Å IN_STOCK
     * (–±–æ –≤–∏–¥–∞–Ω—ñ items —á–∞—Å—Ç–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è)
     */
    @Cacheable(
        value = "items",
        key = "#id",
        condition = "#result != null and #result.status.name() == 'IN_STOCK'"
    )
    public SupplyItemResponseDTO getById(Long id) {
        log.info("Fetching item from database: id={}", id);
        
        SupplyItem item = itemRepository.findById(id)
            .orElseThrow(() -> new ResourceNotFoundException("Item not found"));
        
        return itemMapper.toResponseDTO(item);
    }
    
    /**
     * –ö–µ—à—É–≤–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
     * –ö–ª—é—á: items::category::1
     */
    @Cacheable(value = "items", key = "'category::' + #categoryId")
    public List<SupplyItemResponseDTO> getByCategory(Long categoryId) {
        log.info("Fetching items by category from database: categoryId={}", categoryId);
        
        List<SupplyItem> items = itemRepository.findByCategoryId(categoryId);
        return itemMapper.toResponseDTOList(items);
    }
    
    /**
     * –ü—Ä–∏ –≤–∏–¥–∞—á—ñ - invalidate –∫–µ—à —Ü—å–æ–≥–æ item
     */
    @Transactional
    @CacheEvict(value = "items", key = "#id")
    public void issueItem(Long id, Integer quantity) {
        // –õ–æ–≥—ñ–∫–∞ –≤–∏–¥–∞—á—ñ...
        log.info("Item issued, cache invalidated: id={}", id);
    }
}
```

**Condition —Ç–∞ Unless:**
- `condition` - –∫–µ—à—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —É–º–æ–≤–∞ true (–ø–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º –º–µ—Ç–æ–¥—É)
- `unless` - –ù–ï –∫–µ—à—É–≤–∞—Ç–∏ —è–∫—â–æ —É–º–æ–≤–∞ true (–ø—ñ—Å–ª—è –≤–∏–∫–ª–∏–∫—É –º–µ—Ç–æ–¥—É)

**–ü—Ä–∏–∫–ª–∞–¥–∏:**
```java
@Cacheable(condition = "#id > 10")  // –ö–µ—à—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ id > 10

@Cacheable(unless = "#result == null")  // –ù–µ –∫–µ—à—É–≤–∞—Ç–∏ —è–∫—â–æ result null

@Cacheable(unless = "#result.size() == 0")  // –ù–µ –∫–µ—à—É–≤–∞—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Å–ø–∏—Å–∫–∏
```

---

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–µ—à—É–≤–∞–Ω–Ω—è

**1. –ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç (cache miss):**

```
GET /api/supply-categories/1

–õ–æ–≥–∏:
INFO  SupplyCategoryService - Fetching category from database: id=1
Hibernate: select ... from supply_categories where id=1

–ß–∞—Å: ~50ms
```

**2. –î—Ä—É–≥–∏–π –∑–∞–ø–∏—Ç (cache hit):**

```
GET /api/supply-categories/1

–õ–æ–≥–∏:
(–Ω–µ–º–∞—î –ª–æ–≥—É "Fetching from database")

–ß–∞—Å: ~2ms
```

---

**3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Redis —á–µ—Ä–µ–∑ CLI:**

```bash
docker exec -it military-warehouse-redis redis-cli

127.0.0.1:6379> KEYS *
1) "categories::1"
2) "categories::all"

127.0.0.1:6379> GET categories::1
"{\"id\":1,\"name\":\"–ë–æ—î–ø—Ä–∏–ø–∞—Å–∏ 5.45–º–º\",...}"

127.0.0.1:6379> TTL categories::1
(integer) 86342  # –ó–∞–ª–∏—à–∏–ª–æ—Å—å —Å–µ–∫—É–Ω–¥ –¥–æ expiration
```

---

### Custom Cache Key Generator (–æ–ø—Ü—ñ–π–Ω–æ)

**–Ø–∫—â–æ —Ç—Ä–µ–±–∞ —Å–∫–ª–∞–¥–Ω—ñ—à–∏–π –∫–ª—é—á:**

```java
@Component
public class CustomCacheKeyGenerator implements KeyGenerator {
    
    @Override
    public Object generate(Object target, Method method, Object... params) {
        return target.getClass().getSimpleName() + "_"
            + method.getName() + "_"
            + StringUtils.arrayToDelimitedString(params, "_");
    }
}

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è:
@Cacheable(value = "items", keyGenerator = "customCacheKeyGenerator")
public List<ItemDTO> search(String query, ItemStatus status) {
    // ...
}
// –ö–ª—é—á: SupplyItemService_search_keyword_IN_STOCK
```

---

## üì¢ –ï–¢–ê–ü 6: SPRING EVENTS (25 —Ö–≤)

### –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–Ω—ñ Events?

**–ü—Ä–æ–±–ª–µ–º–∞ –±–µ–∑ Events:**

```java
@Transactional
public void issueItem(Long id, Integer quantity) {
    // 1. –í–∏–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª
    updateItemQuantity(id, quantity);
    
    // 2. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ –∂—É—Ä–Ω–∞–ª—ñ
    createMovementLog(id, quantity);
    
    // 3. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ email –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é
    sendEmailNotification(id, quantity);  // ‚Üê –ü–æ–≤—ñ–ª—å–Ω–æ! 2-3 —Å–µ–∫—É–Ω–¥–∏
    
    // 4. –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    updateStatistics(id);
    
    // 5. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –∑–∞–ø–∞—Å
    checkMinimumStock(id);
}

// –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —á–µ–∫–∞—î 3-4 —Å–µ–∫—É–Ω–¥–∏ –Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å!
```

**–†—ñ—à–µ–Ω–Ω—è - Events:**

```java
@Transactional
public void issueItem(Long id, Integer quantity) {
    // 1. –í–∏–¥–∞—Ç–∏ –º–∞—Ç–µ—Ä—ñ–∞–ª
    updateItemQuantity(id, quantity);
    
    // 2. –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ event
    eventPublisher.publishEvent(new ItemIssuedEvent(id, quantity));  // ‚Üê –ú–∏—Ç—Ç—î–≤–æ!
    
    // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –æ—Ç—Ä–∏–º—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∑–∞ 50ms
}

// Events –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ background:
@EventListener
@Async
public void onItemIssued(ItemIssuedEvent event) {
    sendEmailNotification(event);  // 2-3 —Å–µ–∫—É–Ω–¥–∏, –∞–ª–µ –Ω–µ –±–ª–æ–∫—É—î
    updateStatistics(event);
    checkMinimumStock(event);
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ –®–≤–∏–¥–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
- ‚úÖ Decoupling (—Ä–æ–∑–¥—ñ–ª–µ–Ω–Ω—è concerns)
- ‚úÖ –õ–µ–≥–∫–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –æ–±—Ä–æ–±–∫–∞

---

### –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è Async

**–í –≥–æ–ª–æ–≤–Ω–æ–º—É –∫–ª–∞—Å—ñ:**

```java
@SpringBootApplication
@EnableJpaAuditing
@EnableAsync  // ‚Üê –î–æ–¥–∞–π—Ç–µ —Ü–µ
public class WarehouseApplication {
    public static void main(String[] args) {
        SpringApplication.run(WarehouseApplication.class, args);
    }
}
```

---

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Event –∫–ª–∞—Å—ñ–≤

**–°—Ç–≤–æ—Ä—ñ—Ç—å –ø–∞–∫–µ—Ç `event`:**

**ItemIssuedEvent:**

```java
package ua.edu.viti.warehouse.event;

import lombok.Getter;
import org.springframework.context.ApplicationEvent;
import ua.edu.viti.warehouse.entity.SupplyItem;

import java.time.LocalDateTime;

@Getter
public class ItemIssuedEvent extends ApplicationEvent {
    
    private final Long itemId;
    private final String itemName;
    private final Integer quantity;
    private final String recipientName;
    private final String performedBy;
    private final LocalDateTime timestamp;
    
    public ItemIssuedEvent(Object source, SupplyItem item, Integer quantity,
                           String recipientName, String performedBy) {
        super(source);
        this.itemId = item.getId();
        this.itemName = item.getName();
        this.quantity = quantity;
        this.recipientName = recipientName;
        this.performedBy = performedBy;
        this.timestamp = LocalDateTime.now();
    }
}
```

**ItemReturnedEvent:**

```java
package ua.edu.viti.warehouse.event;

import lombok.Getter;
import org.springframework.context.ApplicationEvent;

import java.time.LocalDateTime;

@Getter
public class ItemReturnedEvent extends ApplicationEvent {
    
    private final Long itemId;
    private final String itemName;
    private final Integer quantity;
    private final String performedBy;
    private final LocalDateTime timestamp;
    
    public ItemReturnedEvent(Object source, Long itemId, String itemName,
                            Integer quantity, String performedBy) {
        super(source);
        this.itemId = itemId;
        this.itemName = itemName;
        this.quantity = quantity;
        this.performedBy = performedBy;
        this.timestamp = LocalDateTime.now();
    }
}
```

**LowStockEvent:**

```java
package ua.edu.viti.warehouse.event;

import lombok.Getter;
import org.springframework.context.ApplicationEvent;

@Getter
public class LowStockEvent extends ApplicationEvent {
    
    private final Long itemId;
    private final String itemName;
    private final Integer currentQuantity;
    private final Integer minimumStock;
    
    public LowStockEvent(Object source, Long itemId, String itemName,
                        Integer currentQuantity, Integer minimumStock) {
        super(source);
        this.itemId = itemId;
        this.itemName = itemName;
        this.currentQuantity = currentQuantity;
        this.minimumStock = minimumStock;
    }
}
```

---

### –ü—É–±–ª—ñ–∫–∞—Ü—ñ—è Events –≤ Service

**–û–Ω–æ–≤–ª–µ–Ω–∏–π MovementService:**

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class SupplyMovementService {
    
    private final SupplyMovementRepository movementRepository;
    private final SupplyItemRepository itemRepository;
    private final ApplicationEventPublisher eventPublisher;  // ‚Üê Inject
    
    @Transactional
    public MovementResponseDTO issueItem(MovementRequestDTO dto) {
        log.info("Issuing item: itemId={}, quantity={}", dto.getItemId(), dto.getQuantity());
        
        SupplyItem item = itemRepository.findById(dto.getItemId())
            .orElseThrow(() -> new ResourceNotFoundException("Item not found"));
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏...
        
        // –ó–º–µ–Ω—à–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        item.setQuantity(item.getQuantity() - dto.getQuantity());
        
        if (item.getQuantity() == 0) {
            item.setStatus(ItemStatus.ISSUED);
        }
        
        itemRepository.save(item);
        
        // –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ –∂—É—Ä–Ω–∞–ª—ñ
        SupplyMovement movement = new SupplyMovement();
        movement.setItem(item);
        movement.setType(MovementType.ISSUE);
        movement.setQuantity(dto.getQuantity());
        movement.setRecipientName(dto.getRecipientName());
        movement.setRecipientUnit(dto.getRecipientUnit());
        movement.setNotes(dto.getNotes());
        movement.setPerformedBy(getCurrentUser());
        
        SupplyMovement saved = movementRepository.save(movement);
        
        // ‚úÖ –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ event
        eventPublisher.publishEvent(
            new ItemIssuedEvent(
                this,
                item,
                dto.getQuantity(),
                dto.getRecipientName(),
                getCurrentUser()
            )
        );
        
        log.info("Item issued successfully. Event published.");
        
        return toResponseDTO(saved);
    }
    
    @Transactional
    public MovementResponseDTO returnItem(MovementRequestDTO dto) {
        // ... –ª–æ–≥—ñ–∫–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
        
        // –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ event
        eventPublisher.publishEvent(
            new ItemReturnedEvent(
                this,
                item.getId(),
                item.getName(),
                dto.getQuantity(),
                getCurrentUser()
            )
        );
        
        return toResponseDTO(saved);
    }
}
```

---

### Event Listeners

**–°—Ç–≤–æ—Ä—ñ—Ç—å EventListener –∫–ª–∞—Å:**

```java
package ua.edu.viti.warehouse.event;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;
import org.springframework.transaction.event.TransactionPhase;
import org.springframework.transaction.event.TransactionalEventListener;
import ua.edu.viti.warehouse.entity.SupplyItem;
import ua.edu.viti.warehouse.repository.SupplyItemRepository;

@Component
@RequiredArgsConstructor
@Slf4j
public class SupplyEventListener {
    
    private final SupplyItemRepository itemRepository;
    
    /**
     * –û–±—Ä–æ–±–Ω–∏–∫ –≤–∏–¥–∞—á—ñ –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
     * @TransactionalEventListener - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ü–Ü–°–õ–Ø commit —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
     * @Async - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–Ω–µ –±–ª–æ–∫—É—î –æ—Å–Ω–æ–≤–Ω–∏–π –ø–æ—Ç—ñ–∫)
     */
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    public void handleItemIssued(ItemIssuedEvent event) {
        log.info("Processing ItemIssuedEvent: item={}, quantity={}, recipient={}",
            event.getItemName(), event.getQuantity(), event.getRecipientName());
        
        try {
            // 1. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ email –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é (—ñ–º—ñ—Ç–∞—Ü—ñ—è)
            sendEmailNotification(event);
            
            // 2. –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateStatistics(event);
            
            // 3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –Ω–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å
            checkLowStock(event.getItemId());
            
            log.info("ItemIssuedEvent processed successfully");
            
        } catch (Exception e) {
            log.error("Error processing ItemIssuedEvent", e);
            // –í —Ä–µ–∞–ª—å–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ - –ø–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ –∞–±–æ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ dead letter queue
        }
    }
    
    /**
     * –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
     */
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    public void handleItemReturned(ItemReturnedEvent event) {
        log.info("Processing ItemReturnedEvent: item={}, quantity={}",
            event.getItemName(), event.getQuantity());
        
        try {
            sendEmailNotification(event);
            updateStatistics(event);
            
            log.info("ItemReturnedEvent processed successfully");
            
        } catch (Exception e) {
            log.error("Error processing ItemReturnedEvent", e);
        }
    }
    
    /**
     * –û–±—Ä–æ–±–Ω–∏–∫ –Ω–∏–∑—å–∫–æ–≥–æ –∑–∞–ø–∞—Å—É
     * –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –æ–¥—Ä–∞–∑—É
     */
    @EventListener
    public void handleLowStock(LowStockEvent event) {
        log.warn("LOW STOCK ALERT: item={}, current={}, minimum={}",
            event.getItemName(), event.getCurrentQuantity(), event.getMinimumStock());
        
        // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫—Ä–∏—Ç–∏—á–Ω—É –Ω–æ—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é
        sendCriticalAlert(event);
    }
    
    // Helper –º–µ—Ç–æ–¥–∏
    
    private void sendEmailNotification(ItemIssuedEvent event) {
        // –Ü–º—ñ—Ç–∞—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ email
        log.info("Sending email notification to warehouse manager about issue: {}",
            event.getItemName());
        
        try {
            Thread.sleep(2000);  // –Ü–º—ñ—Ç–∞—Ü—ñ—è –∑–∞—Ç—Ä–∏–º–∫–∏
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        
        log.info("Email sent successfully");
    }
    
    private void sendEmailNotification(ItemReturnedEvent event) {
        log.info("Sending email notification about return: {}", event.getItemName());
        
        try {
            Thread.sleep(1500);
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
    
    private void updateStatistics(ItemIssuedEvent event) {
        log.info("Updating statistics for issued item: {}", event.getItemName());
        // –í —Ä–µ–∞–ª—å–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ - –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –æ–∫—Ä–µ–º—É —Ç–∞–±–ª–∏—Ü—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    }
    
    private void updateStatistics(ItemReturnedEvent event) {
        log.info("Updating statistics for returned item: {}", event.getItemName());
    }
    
    private void checkLowStock(Long itemId) {
        itemRepository.findById(itemId).ifPresent(item -> {
            // –Ø–∫—â–æ —î –ø–æ–ª–µ minimumStock (–¥–æ–¥–∞–π—Ç–µ –≤ Entity —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
            Integer minimumStock = 100;  // –ê–±–æ –∑ –ë–î
            
            if (item.getQuantity() < minimumStock) {
                // –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –Ω–æ–≤–∏–π event
                log.warn("Low stock detected for item: {}", item.getName());
                // eventPublisher.publishEvent(new LowStockEvent(...));
            }
        });
    }
    
    private void sendCriticalAlert(LowStockEvent event) {
        log.error("CRITICAL: Sending SMS/Push notification about low stock: {}",
            event.getItemName());
    }
}
```

**–í–∞–∂–ª–∏–≤—ñ –∞–Ω–æ—Ç–∞—Ü—ñ—ó:**
- `@EventListener` - –ø—Ä–æ—Å—Ç–∏–π listener (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π)
- `@TransactionalEventListener` - –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –≤ –ø–µ–≤–Ω—ñ–π —Ñ–∞–∑—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
  - `AFTER_COMMIT` - –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ commit (–Ω–∞–π–±–µ–∑–ø–µ—á–Ω—ñ—à–µ)
  - `BEFORE_COMMIT` - –ø–µ—Ä–µ–¥ commit
  - `AFTER_ROLLBACK` - –ø—ñ—Å–ª—è rollback
  - `AFTER_COMPLETION` - –ø—ñ—Å–ª—è commit –∞–±–æ rollback
- `@Async` - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–µ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

---

### –ü–µ—Ä–µ–≤–∞–≥–∏ Events vs –ø—Ä—è–º—ñ –≤–∏–∫–ª–∏–∫–∏

**–ë–µ–∑ Events (—Ç—ñ—Å–Ω–∞ –∑–≤'—è–∑–∞–Ω—ñ—Å—Ç—å):**

```java
@Service
public class MovementService {
    private final EmailService emailService;
    private final StatisticsService statisticsService;
    private final NotificationService notificationService;
    
    public void issueItem() {
        // ...
        emailService.send();  // ‚Üê –ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å
        statisticsService.update();  // ‚Üê –ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å
        notificationService.notify();  // ‚Üê –ó–∞–ª–µ–∂–Ω—ñ—Å—Ç—å
    }
}
```

**–ó Events (decoupled):**

```java
@Service
public class MovementService {
    private final ApplicationEventPublisher eventPublisher;
    
    public void issueItem() {
        // ...
        eventPublisher.publishEvent(new ItemIssuedEvent(...));  // ‚Üê –ë–µ–∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
    }
}

// Listeners –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤ –æ–∫—Ä–µ–º–∏—Ö –º–æ–¥—É–ª—è—Ö!
```

---

## üìä –ï–¢–ê–ü 7: OBSERVABILITY (20 —Ö–≤)

### –©–æ —Ç–∞–∫–µ Observability?

**Observability** - –∑–¥–∞—Ç–Ω—ñ—Å—Ç—å —Ä–æ–∑—É–º—ñ—Ç–∏ —Å—Ç–∞–Ω —Å–∏—Å—Ç–µ–º–∏ —á–µ—Ä–µ–∑:
1. **Metrics** - —á–∏—Å–ª–æ–≤—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ (RPS, latency, errors)
2. **Logs** - –ø–æ–¥—ñ—ó —â–æ –≤—ñ–¥–±—É–ª–∏—Å—å (structured JSON)
3. **Traces** - —à–ª—è—Ö –∑–∞–ø–∏—Ç—É —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É (Correlation ID)

**–ß–æ–º—É —Ü–µ –≤–∞–∂–ª–∏–≤–æ:**
- ‚úÖ –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
- ‚úÖ –®–≤–∏–¥–∫–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ê–Ω–∞–ª—ñ–∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
- ‚úÖ Capacity planning

---

### Custom Metrics –∑ Micrometer

**Micrometer** - facade –¥–ª—è metrics (—è–∫ SLF4J –¥–ª—è –ª–æ–≥—ñ–≤).

**–î–æ–¥–∞–π—Ç–µ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å:**

```xml
<!-- Actuator –º—ñ—Å—Ç–∏—Ç—å Micrometer -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

**–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è `application.properties`:**

```properties
# Actuator Configuration
management.endpoints.web.exposure.include=health,metrics,prometheus
management.endpoint.health.show-details=always
management.metrics.export.prometheus.enabled=true

# Custom application info
management.info.env.enabled=true
info.app.name=Military Warehouse API
info.app.version=2.0.0
info.app.stage=Stage 2
```

---

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Custom Metrics

**MetricsService:**

```java
package ua.edu.viti.warehouse.service;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.concurrent.TimeUnit;

@Service
@Slf4j
public class MetricsService {
    
    private final MeterRegistry meterRegistry;
    
    // Counters - –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
    private final Counter itemsIssuedCounter;
    private final Counter itemsReturnedCounter;
    private final Counter lowStockAlertsCounter;
    
    // Timers - –≤–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ
    private final Timer issueOperationTimer;
    
    public MetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è metrics
        this.itemsIssuedCounter = Counter.builder("warehouse.items.issued")
            .description("Total number of items issued")
            .tag("type", "supply")
            .register(meterRegistry);
        
        this.itemsReturnedCounter = Counter.builder("warehouse.items.returned")
            .description("Total number of items returned")
            .tag("type", "supply")
            .register(meterRegistry);
        
        this.lowStockAlertsCounter = Counter.builder("warehouse.alerts.low_stock")
            .description("Number of low stock alerts triggered")
            .tag("severity", "warning")
            .register(meterRegistry);
        
        this.issueOperationTimer = Timer.builder("warehouse.operations.issue.duration")
            .description("Time taken to issue items")
            .tag("operation", "issue")
            .register(meterRegistry);
    }
    
    /**
     * –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –≤–∏–¥–∞—á—É –º–∞—Ç–µ—Ä—ñ–∞–ª—ñ–≤
     */
    public void recordItemIssued(String itemName, Integer quantity) {
        itemsIssuedCounter.increment(quantity);
        
        // –î–æ–¥–∞—Ç–∫–æ–≤–∏–π gauge –¥–ª—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
        meterRegistry.gauge("warehouse.items.last_issued_quantity", quantity);
        
        log.debug("Metric recorded: items issued - {}, quantity - {}", itemName, quantity);
    }
    
    /**
     * –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
     */
    public void recordItemReturned(Integer quantity) {
        itemsReturnedCounter.increment(quantity);
    }
    
    /**
     * –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–∏–∑—å–∫–∏–π –∑–∞–ø–∞—Å
     */
    public void recordLowStockAlert(String itemName) {
        lowStockAlertsCounter.increment();
        
        log.warn("Low stock alert metric incremented for: {}", itemName);
    }
    
    /**
     * –í–∏–º—ñ—Ä—è—Ç–∏ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ—ó
     */
    public <T> T measureIssueOperation(java.util.function.Supplier<T> operation) {
        return issueOperationTimer.record(operation);
    }
    
    /**
     * –í–∏–º—ñ—Ä—è—Ç–∏ –∑ —è–≤–Ω–∏–º —Ç–∞–π–º–µ—Ä–æ–º
     */
    public Timer.Sample startTimer() {
        return Timer.start(meterRegistry);
    }
    
    public void stopTimer(Timer.Sample sample, String timerName) {
        sample.stop(Timer.builder(timerName)
            .register(meterRegistry));
    }
}
```

---

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è Metrics –≤ Service

**–û–Ω–æ–≤–ª–µ–Ω–∏–π MovementService:**

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional(readOnly = true)
public class SupplyMovementService {
    
    private final SupplyMovementRepository movementRepository;
    private final SupplyItemRepository itemRepository;
    private final ApplicationEventPublisher eventPublisher;
    private final MetricsService metricsService;  // ‚Üê Inject
    
    @Transactional
    public MovementResponseDTO issueItem(MovementRequestDTO dto) {
        log.info("Issuing item: itemId={}, quantity={}", dto.getItemId(), dto.getQuantity());
        
        // ‚úÖ –í–∏–º—ñ—Ä—è—Ç–∏ —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ—ó
        return metricsService.measureIssueOperation(() -> {
            
            SupplyItem item = itemRepository.findById(dto.getItemId())
                .orElseThrow(() -> new ResourceNotFoundException("Item not found"));
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç–∞ –ª–æ–≥—ñ–∫–∞...
            
            item.setQuantity(item.getQuantity() - dto.getQuantity());
            
            if (item.getQuantity() == 0) {
                item.setStatus(ItemStatus.ISSUED);
            }
            
            itemRepository.save(item);
            
            SupplyMovement movement = new SupplyMovement();
            // ... –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –ø–æ–ª—ñ–≤
            
            SupplyMovement saved = movementRepository.save(movement);
            
            // ‚úÖ –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ metric
            metricsService.recordItemIssued(item.getName(), dto.getQuantity());
            
            // –û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ event
            eventPublisher.publishEvent(
                new ItemIssuedEvent(this, item, dto.getQuantity(), 
                    dto.getRecipientName(), getCurrentUser())
            );
            
            log.info("Item issued successfully");
            
            return toResponseDTO(saved);
        });
    }
    
    @Transactional
    public MovementResponseDTO returnItem(MovementRequestDTO dto) {
        // ... –ª–æ–≥—ñ–∫–∞
        
        metricsService.recordItemReturned(dto.getQuantity());
        
        return toResponseDTO(saved);
    }
}
```

---

### Metrics –≤ EventListener

```java
@Component
@RequiredArgsConstructor
@Slf4j
public class SupplyEventListener {
    
    private final SupplyItemRepository itemRepository;
    private final MetricsService metricsService;
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    @Async
    public void handleItemIssued(ItemIssuedEvent event) {
        log.info("Processing ItemIssuedEvent: item={}", event.getItemName());
        
        try {
            sendEmailNotification(event);
            updateStatistics(event);
            checkLowStock(event.getItemId());
            
        } catch (Exception e) {
            log.error("Error processing ItemIssuedEvent", e);
        }
    }
    
    @EventListener
    public void handleLowStock(LowStockEvent event) {
        log.warn("LOW STOCK ALERT: item={}, current={}, minimum={}",
            event.getItemName(), event.getCurrentQuantity(), event.getMinimumStock());
        
        // ‚úÖ –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ alert metric
        metricsService.recordLowStockAlert(event.getItemName());
        
        sendCriticalAlert(event);
    }
}
```

---

### –ü–µ—Ä–µ–≥–ª—è–¥ Metrics

**1. –ß–µ—Ä–µ–∑ Actuator endpoints:**

```bash
# –í—Å—ñ metrics
curl http://localhost:8080/actuator/metrics

# –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞ metric
curl http://localhost:8080/actuator/metrics/warehouse.items.issued

# –í—ñ–¥–ø–æ–≤—ñ–¥—å:
{
  "name": "warehouse.items.issued",
  "description": "Total number of items issued",
  "measurements": [
    {
      "statistic": "COUNT",
      "value": 1250.0
    }
  ],
  "availableTags": [
    {
      "tag": "type",
      "values": ["supply"]
    }
  ]
}
```

---

**2. Prometheus format (–¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É):**

```bash
curl http://localhost:8080/actuator/prometheus

# –í—ñ–¥–ø–æ–≤—ñ–¥—å:
# HELP warehouse_items_issued_total Total number of items issued
# TYPE warehouse_items_issued_total counter
warehouse_items_issued_total{type="supply"} 1250.0

# HELP warehouse_operations_issue_duration_seconds Time taken to issue items
# TYPE warehouse_operations_issue_duration_seconds summary
warehouse_operations_issue_duration_seconds_count{operation="issue"} 85.0
warehouse_operations_issue_duration_seconds_sum{operation="issue"} 4.25
```

**–í production** —Ü—ñ metrics –∑–±–∏—Ä–∞—î Prometheus, –≤—ñ–∑—É–∞–ª—ñ–∑—É—î Grafana.

---

### Structured Logging (JSON)

**–ù–∞–≤—ñ—â–æ JSON –ª–æ–≥–∏:**
- ‚úÖ –õ–µ–≥–∫–æ –ø–∞—Ä—Å–∏—Ç–∏
- ‚úÖ –Ü–Ω–¥–µ–∫—Å—É–≤–∞—Ç–∏ –≤ Elasticsearch/Splunk
- ‚úÖ –§—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ —Ç–∞ —à—É–∫–∞—Ç–∏
- ‚úÖ –î–æ–¥–∞–≤–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç (correlation ID, user)

**–î–æ–¥–∞–π—Ç–µ –∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å:**

```xml
<!-- Logback JSON encoder -->
<dependency>
    <groupId>net.logstash.logback</groupId>
    <artifactId>logstash-logback-encoder</artifactId>
    <version>7.4</version>
</dependency>
```

---

**–°—Ç–≤–æ—Ä—ñ—Ç—å `src/main/resources/logback-spring.xml`:**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    
    <!-- Console appender (–¥–ª—è —Ä–æ–∑—Ä–æ–±–∫–∏) -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
        </encoder>
    </appender>
    
    <!-- JSON appender (–¥–ª—è production) -->
    <appender name="JSON" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeMdcKeyName>correlationId</includeMdcKeyName>
            <includeMdcKeyName>userId</includeMdcKeyName>
            <includeMdcKeyName>operation</includeMdcKeyName>
        </encoder>
    </appender>
    
    <!-- File appender (–¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–≥—ñ–≤) -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/warehouse.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/warehouse-%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder class="net.logstash.logback.encoder.LogstashEncoder"/>
    </appender>
    
    <!-- Profile-based configuration -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
    
    <springProfile name="prod">
        <root level="WARN">
            <appender-ref ref="JSON"/>
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>
    
    <!-- Package-specific levels -->
    <logger name="ua.edu.viti.warehouse" level="DEBUG"/>
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.hibernate.SQL" level="DEBUG"/>
    
</configuration>
```

---

### Correlation ID –¥–ª—è tracing

**–°—Ç–≤–æ—Ä—ñ—Ç—å `CorrelationIdFilter`:**

```java
package ua.edu.viti.warehouse.config;

import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.slf4j.MDC;
import org.springframework.stereotype.Component;

import java.io.IOException;
import java.util.UUID;

@Component
public class CorrelationIdFilter implements Filter {
    
    private static final String CORRELATION_ID_HEADER = "X-Correlation-Id";
    private static final String CORRELATION_ID_MDC_KEY = "correlationId";
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        try {
            // 1. –û—Ç—Ä–∏–º–∞—Ç–∏ –∞–±–æ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ Correlation ID
            String correlationId = httpRequest.getHeader(CORRELATION_ID_HEADER);
            
            if (correlationId == null || correlationId.isEmpty()) {
                correlationId = UUID.randomUUID().toString();
            }
            
            // 2. –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –≤ MDC (Mapped Diagnostic Context)
            MDC.put(CORRELATION_ID_MDC_KEY, correlationId);
            
            // 3. –î–æ–¥–∞—Ç–∏ –≤ response header
            httpResponse.setHeader(CORRELATION_ID_HEADER, correlationId);
            
            // 4. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –æ–±—Ä–æ–±–∫—É
            chain.doFilter(request, response);
            
        } finally {
            // 5. –û—á–∏—Å—Ç–∏—Ç–∏ MDC –ø—ñ—Å–ª—è –æ–±—Ä–æ–±–∫–∏
            MDC.remove(CORRELATION_ID_MDC_KEY);
        }
    }
}
```

**–¢–µ–ø–µ—Ä –∫–æ–∂–µ–Ω –ª–æ–≥ –º–∞—î correlationId:**

```json
{
  "timestamp": "2024-12-01T15:30:00.123Z",
  "level": "INFO",
  "thread": "http-nio-8080-exec-1",
  "logger": "ua.edu.viti.warehouse.service.SupplyMovementService",
  "message": "Issuing item: itemId=1, quantity=100",
  "correlationId": "a1b2c3d4-e5f6-4789-0abc-def123456789",
  "userId": "admin",
  "operation": "issue_item"
}
```

**–ö–æ—Ä–∏—Å—Ç—å:** –ú–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –≤—Å—ñ –ª–æ–≥–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–ø–∏—Ç—É –ø–æ correlationId!

---

### –î–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤ –ª–æ–≥–∏

**–£ Service –º–µ—Ç–æ–¥–∞—Ö:**

```java
@Service
@RequiredArgsConstructor
@Slf4j
public class SupplyMovementService {
    
    @Transactional
    public MovementResponseDTO issueItem(MovementRequestDTO dto) {
        // –î–æ–¥–∞—Ç–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ MDC
        MDC.put("operation", "issue_item");
        MDC.put("itemId", dto.getItemId().toString());
        MDC.put("userId", getCurrentUser());
        
        try {
            log.info("Issuing item: itemId={}, quantity={}", dto.getItemId(), dto.getQuantity());
            
            // ... –ª–æ–≥—ñ–∫–∞
            
            log.info("Item issued successfully");
            
            return result;
            
        } finally {
            // –û—á–∏—Å—Ç–∏—Ç–∏ MDC
            MDC.remove("operation");
            MDC.remove("itemId");
        }
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç JSON log:**

```json
{
  "timestamp": "2024-12-01T15:30:00.123Z",
  "level": "INFO",
  "message": "Issuing item: itemId=1, quantity=100",
  "correlationId": "a1b2c3d4-...",
  "userId": "admin",
  "operation": "issue_item",
  "itemId": "1"
}
```

---

### Health Checks

**Custom Health Indicator:**

```java
package ua.edu.viti.warehouse.config;

import lombok.RequiredArgsConstructor;
import org.springframework.boot.actuate.health.Health;
import org.springframework.boot.actuate.health.HealthIndicator;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

@Component
@RequiredArgsConstructor
public class WarehouseHealthIndicator implements HealthIndicator {
    
    private final RedisTemplate<String, Object> redisTemplate;
    
    @Override
    public Health health() {
        try {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ Redis
            redisTemplate.opsForValue().set("health:check", "ok");
            String value = (String) redisTemplate.opsForValue().get("health:check");
            
            if ("ok".equals(value)) {
                return Health.up()
                    .withDetail("redis", "Connected")
                    .withDetail("cache", "Available")
                    .build();
            } else {
                return Health.down()
                    .withDetail("redis", "Connection issue")
                    .build();
            }
            
        } catch (Exception e) {
            return Health.down()
                .withDetail("redis", "Down")
                .withException(e)
                .build();
        }
    }
}
```

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞:**

```bash
curl http://localhost:8080/actuator/health

{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "PostgreSQL",
        "validationQuery": "isValid()"
      }
    },
    "warehouse": {
      "status": "UP",
      "details": {
        "redis": "Connected",
        "cache": "Available"
      }
    }
  }
}
```

---

## üìã –ö–†–ò–¢–ï–†–Ü–á –û–¶–Ü–ù–Æ–í–ê–ù–ù–Ø (65 –±–∞–ª—ñ–≤)

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (GitHub Actions)

**–ü—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ Pull Request `stage-2` ‚Üí `main`:**

1. ‚úÖ **–ö–æ–º–ø—ñ–ª—è—Ü—ñ—è** (–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)
   - `mvn clean compile`
   - –Ø–∫—â–æ –Ω–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è ‚Üí 0 –±–∞–ª—ñ–≤

2. ‚úÖ **MapStruct –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è**
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö Mapper –∫–ª–∞—Å—ñ–≤
   - –Ø–∫—â–æ –Ω–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–ª–∏—Å—å ‚Üí -5 –±–∞–ª—ñ–≤

3. ‚úÖ **Liquibase –≤–∞–ª—ñ–¥–∞—Ü—ñ—è**
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å—É changesets
   - –°–ø—Ä–æ–±–∞ apply –º—ñ–≥—Ä–∞—Ü—ñ–π –Ω–∞ —Ç–µ—Å—Ç–æ–≤—É –ë–î

4. ‚úÖ **Security —Ç–µ—Å—Ç–∏**
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ –±–µ–∑ JWT ‚Üí 403
   - –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —â–æ –∑ –≤–∞–ª—ñ–¥–Ω–∏–º JWT ‚Üí 200

5. ‚úÖ **Integration —Ç–µ—Å—Ç–∏**
   - –¢–µ—Å—Ç–∏ –Ω–∞ MovementLog —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
   - –¢–µ—Å—Ç–∏ –Ω–∞ Event publishing

---

### –†—É—á–Ω–µ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è (–≤–∏–∫–ª–∞–¥–∞—á–µ–º)

#### 1. Liquibase –º—ñ–≥—Ä–∞—Ü—ñ—ó (10 –±–∞–ª—ñ–≤)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ changesets (4 –±–∞–ª–∏):**
- –§–∞–π–ª `db.changelog-master.yaml` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
- –ú—ñ–Ω—ñ–º—É–º 6 changesets (categories, items, locations, movements, users, indexes)
- –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–æ—Ä—è–¥–æ–∫ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è (dependencies)
- –ù–∞–∑–≤–∏ —Ñ–∞–π–ª—ñ–≤ –∑–∞ –∫–æ–Ω–≤–µ–Ω—Ü—ñ—î—é (`001-create-...`, `002-...`)

‚úÖ **–Ø–∫—ñ—Å—Ç—å changesets (3 –±–∞–ª–∏):**
- –í—Å—ñ –∫–æ–ª–æ–Ω–∫–∏ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ —Ç–∏–ø–∞–º–∏
- Foreign keys –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º onDelete
- –Ü–Ω–¥–µ–∫—Å–∏ –Ω–∞ —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–Ω–∏—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö
- Rollback —Å–µ–∫—Ü—ñ—ó –ø—Ä–∏—Å—É—Ç–Ω—ñ

‚úÖ **Seed data (2 –±–∞–ª–∏):**
- –ú—ñ–Ω—ñ–º—É–º 3 –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
- –ú—ñ–Ω—ñ–º—É–º 3 —Ä–æ–ª—ñ (ADMIN, OPERATOR, VIEWER)
- –ü–æ—á–∞—Ç–∫–æ–≤–∏–π admin –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
- –¢–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó

‚úÖ **DDL –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (1 –±–∞–ª):**
- `spring.jpa.hibernate.ddl-auto=none` (Liquibase –∫–µ—Ä—É—î —Å—Ö–µ–º–æ—é)
- –î–æ–¥–∞—Ç–æ–∫ —Å—Ç–∞—Ä—Ç—É—î –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- –ú—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ

**–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤:**
- –í—Å—ñ changesets —Å—Ç–≤–æ—Ä–µ–Ω—ñ —Ç–∞ –ø—Ä–∞—Ü—é—é—Ç—å: 10 –±–∞–ª—ñ–≤
- –Ñ –ø–æ–º–∏–ª–∫–∏ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ –∞–±–æ rollback: 7-9 –±–∞–ª—ñ–≤
- –ù–µ–º–∞—î seed data: -2 –±–∞–ª–∏
- DDL –Ω–µ –≤–∏–º–∫–Ω–µ–Ω–æ: -1 –±–∞–ª

---

#### 2. MovementLog + –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó (12 –±–∞–ª—ñ–≤)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

‚úÖ **MovementLog Entity (3 –±–∞–ª–∏):**
- –ü—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (item, type, quantity, recipient, performedBy, performedAt)
- `@Version` –¥–ª—è Optimistic Locking
- –ó–≤'—è–∑–æ–∫ –∑ Item —á–µ—Ä–µ–∑ `@ManyToOne`
- MovementType enum

‚úÖ **MovementRepository (2 –±–∞–ª–∏):**
- Query –º–µ—Ç–æ–¥–∏ (findByItemId, findByType, findByPerformedAtBetween)
- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–Ω—ñ –∑–∞–ø–∏—Ç–∏ (calculateTotalQuantity)

‚úÖ **MovementService - —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó (5 –±–∞–ª—ñ–≤):**
- `@Transactional` –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º `isolation` (REPEATABLE_READ –∞–±–æ –≤–∏—â–µ)
- –ú–µ—Ç–æ–¥–∏: issueItem, returnItem, writeOffItem
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏ (–Ω–∞—è–≤–Ω—ñ—Å—Ç—å, —Ç–µ—Ä–º—ñ–Ω, –∫—ñ–ª—å–∫—ñ—Å—Ç—å)
- –û–Ω–æ–≤–ª–µ–Ω–Ω—è Item quantity —Ç–∞ status
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è MovementLog –∑–∞–ø–∏—Å—É
- –í–∏–∫–∏–¥–∞–Ω–Ω—è Exception –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö

‚úÖ **MovementController (2 –±–∞–ª–∏):**
- Endpoints: POST /movements/issue, /movements/return, /movements/write-off
- GET /movements/item/{itemId} - —ñ—Å—Ç–æ—Ä—ñ—è
- @PreAuthorize –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É
- Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

**–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤:**
- –ü–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏: 12 –±–∞–ª—ñ–≤
- –ù–µ–º–∞—î Optimistic Locking: -2 –±–∞–ª–∏
- –ù–µ–º–∞—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ isolation: -2 –±–∞–ª–∏
- –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: -3 –±–∞–ª–∏

---

#### 3. JWT Security (15 –±–∞–ª—ñ–≤)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

‚úÖ **User/Role Entity (3 –±–∞–ª–∏):**
- User Entity –∑ –ø–æ–ª—è–º–∏ (username, email, password, roles)
- Role Entity –∑ RoleName enum
- `@ManyToMany` –∑–≤'—è–∑–æ–∫
- Liquibase –º—ñ–≥—Ä–∞—Ü—ñ—ó –¥–ª—è —Ç–∞–±–ª–∏—Ü—å

‚úÖ **JWT Infrastructure (4 –±–∞–ª–∏):**
- JwtUtils (generateToken, validateToken, getUsernameFromToken)
- Secret key –º—ñ–Ω—ñ–º—É–º 256 –±—ñ—Ç
- Expiration –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
- CustomUserDetailsService

‚úÖ **Security Configuration (4 –±–∞–ª–∏):**
- JwtAuthenticationFilter
- SecurityConfig –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ rules
- STATELESS session
- CSRF disabled
- @EnableMethodSecurity

‚úÖ **Auth Endpoints (2 –±–∞–ª–∏):**
- POST /api/auth/login - –≥–µ–Ω–µ—Ä—É—î JWT
- POST /api/auth/register - —Å—Ç–≤–æ—Ä—é—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è DTO
- BCrypt password hashing

‚úÖ **Authorization (2 –±–∞–ª–∏):**
- @PreAuthorize –Ω–∞ endpoints
- ADMIN - –≤—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
- OPERATOR - CRUD –æ–∫—Ä—ñ–º DELETE
- VIEWER - —Ç—ñ–ª—å–∫–∏ GET
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∞—Ü—é—î (403 –ø—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π —Ä–æ–ª—ñ)

**–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤:**
- –ü–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: 15 –±–∞–ª—ñ–≤
- JWT –ø—Ä–∞—Ü—é—î –∞–ª–µ –±–µ–∑ —Ä–æ–ª–µ–π: 10 –±–∞–ª—ñ–≤
- –¢—ñ–ª—å–∫–∏ User/Role Entity: 5 –±–∞–ª—ñ–≤
- Weak secret key (<256 –±—ñ—Ç): -2 –±–∞–ª–∏
- –ù–µ–º–∞—î @PreAuthorize: -3 –±–∞–ª–∏

---

#### 4. MapStruct –º–∞–ø–ø—ñ–Ω–≥ (8 –±–∞–ª—ñ–≤)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

‚úÖ **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (2 –±–∞–ª–∏):**
- MapStruct dependency –≤ pom.xml
- Annotation processor –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
- Lombok-MapStruct binding
- –ö–æ–¥ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è

‚úÖ **Mapper —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ (4 –±–∞–ª–∏):**
- CategoryMapper (toResponseDTO, toEntity, updateEntity)
- ItemMapper –∑ –≤–∫–ª–∞–¥–µ–Ω–∏–º–∏ –æ–±'—î–∫—Ç–∞–º–∏
- `@Mapper(componentModel = "spring")`
- –ü—Ä–∞–≤–∏–ª—å–Ω—ñ `@Mapping` –∞–Ω–æ—Ç–∞—Ü—ñ—ó

‚úÖ **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ Service (2 –±–∞–ª–∏):**
- –í–∏–¥–∞–ª–µ–Ω–æ —Ä—É—á–Ω–∏–π –º–∞–ø–ø—ñ–Ω–≥
- Mappers inject —á–µ—Ä–µ–∑ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –≤—Å—ñ—Ö conversions
- `@BeanMapping(nullValuePropertyMappingStrategy = IGNORE)` –¥–ª—è updates

**–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤:**
- –ü–æ–≤–Ω–∞ –∑–∞–º—ñ–Ω–∞ —Ä—É—á–Ω–æ–≥–æ –º–∞–ø–ø—ñ–Ω–≥—É: 8 –±–∞–ª—ñ–≤
- –¢—ñ–ª—å–∫–∏ –±–∞–∑–æ–≤—ñ mappers: 6 –±–∞–ª—ñ–≤
- –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ Service: -3 –±–∞–ª–∏
- –ù–µ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è: 0 –±–∞–ª—ñ–≤

---

#### 5. Redis Caching (8 –±–∞–ª—ñ–≤)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

‚úÖ **–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (2 –±–∞–ª–∏):**
- Redis Docker container
- Spring Data Redis dependency
- CacheConfig –∑ RedisCacheManager
- –†—ñ–∑–Ω—ñ TTL –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –∫–µ—à—ñ–≤

‚úÖ **–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∞–Ω–æ—Ç–∞—Ü—ñ–π (4 –±–∞–ª–∏):**
- `@Cacheable` –Ω–∞ read –º–µ—Ç–æ–¥–∞—Ö (categories, warehouses)
- `@CacheEvict` –Ω–∞ write –º–µ—Ç–æ–¥–∞—Ö (create, update, delete)
- –ü—Ä–∞–≤–∏–ª—å–Ω—ñ cache names —Ç–∞ keys
- `condition` –∞–±–æ `unless` –¥–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—ó–≤ (–æ–ø—Ü—ñ–π–Ω–æ)

‚úÖ **–ü—Ä–∞—Ü–µ–∑–¥–∞—Ç–Ω—ñ—Å—Ç—å (2 –±–∞–ª–∏):**
- –ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç - cache miss (–ø–æ–≤—ñ–ª—å–Ω–æ)
- –î—Ä—É–≥–∏–π –∑–∞–ø–∏—Ç - cache hit (—à–≤–∏–¥–∫–æ)
- Invalidation –ø—Ä–∞—Ü—é—î (–ø—ñ—Å–ª—è update - –Ω–æ–≤–∏–π –∫–µ—à)
- Redis –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω—ñ (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ redis-cli)

**–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤:**
- –ü–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: 8 –±–∞–ª—ñ–≤
- –ö–µ—à—É—î—Ç—å—Å—è –∞–ª–µ –Ω–µ invalidate: 6 –±–∞–ª—ñ–≤
- –¢—ñ–ª—å–∫–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è: 3 –±–∞–ª–∏
- Redis –Ω–µ –ø—Ä–∞—Ü—é—î: 0 –±–∞–ª—ñ–≤

---

#### 6. Spring Events (6 –±–∞–ª—ñ–≤)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

‚úÖ **Event –∫–ª–∞—Å–∏ (2 –±–∞–ª–∏):**
- –ú—ñ–Ω—ñ–º—É–º 2 events (ItemIssuedEvent, ItemReturnedEvent)
- Extends ApplicationEvent
- –ú—ñ—Å—Ç—è—Ç—å –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–∞–Ω—ñ (itemId, quantity, performedBy, timestamp)

‚úÖ **Event Publishing (2 –±–∞–ª–∏):**
- ApplicationEventPublisher inject –≤ Service
- publishEvent() –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –æ–ø–µ—Ä–∞—Ü—ñ—ó
- Event –º—ñ—Å—Ç–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ

‚úÖ **Event Listeners (2 –±–∞–ª–∏):**
- @EventListener –∞–±–æ @TransactionalEventListener
- @Async –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—ó –æ–±—Ä–æ–±–∫–∏
- –õ–æ–≥—É–≤–∞–Ω–Ω—è/metrics/notifications –≤ listeners
- Try-catch –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫

**–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤:**
- –ü–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: 6 –±–∞–ª—ñ–≤
- –ù–µ–º–∞—î @Async: -1 –±–∞–ª
- –ù–µ–º–∞—î –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫: -1 –±–∞–ª
- Events –Ω–µ –ø—É–±–ª—ñ–∫—É—é—Ç—å—Å—è: 0 –±–∞–ª—ñ–≤

---

#### 7. Metrics + Logging (6 –±–∞–ª—ñ–≤)

**–©–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è:**

‚úÖ **Custom Metrics (3 –±–∞–ª–∏):**
- MetricsService –∑ Micrometer
- –ú—ñ–Ω—ñ–º—É–º 2 counters (items issued/returned)
- –ú—ñ–Ω—ñ–º—É–º 1 timer (operation duration)
- Metrics –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è –≤ Service
- /actuator/metrics –¥–æ—Å—Ç—É–ø–Ω–∏–π

‚úÖ **Structured Logging (3 –±–∞–ª–∏):**
- Logback JSON encoder
- Correlation ID filter
- MDC –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (userId, operation)
- JSON –ª–æ–≥–∏ –≤ production profile

**–†–æ–∑–ø–æ–¥—ñ–ª –±–∞–ª—ñ–≤:**
- –ü–æ–≤–Ω–∞ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—è: 6 –±–∞–ª—ñ–≤
- –¢—ñ–ª—å–∫–∏ metrics: 3 –±–∞–ª–∏
- –¢—ñ–ª—å–∫–∏ logging: 3 –±–∞–ª–∏
- Actuator –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π: -1 –±–∞–ª

---

### –¢–∞–±–ª–∏—Ü—è –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è Stage 2

| –ö—Ä–∏—Ç–µ—Ä—ñ–π | –ú–∞–∫—Å–∏–º—É–º | –ú—ñ–Ω—ñ–º—É–º –¥–ª—è –∑–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è |
|----------|----------|-------------------------|
| Liquibase –º—ñ–≥—Ä–∞—Ü—ñ—ó | 10 | 6 |
| MovementLog + –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó | 12 | 7 |
| JWT Security | 15 | 10 |
| MapStruct | 8 | 5 |
| Redis Caching | 8 | 5 |
| Spring Events | 6 | 4 |
| Metrics + Logging | 6 | 3 |
| **–ó–ê–ì–ê–õ–û–ú** | **65** | **40** |

**–®–∫–∞–ª–∞ –æ—Ü—ñ–Ω—é–≤–∞–Ω–Ω—è:**
- 59-65 –±–∞–ª—ñ–≤ (90%+) - –í—ñ–¥–º—ñ–Ω–Ω–æ
- 49-58 –±–∞–ª—ñ–≤ (75-89%) - –î–æ–±—Ä–µ
- 40-48 –±–∞–ª—ñ–≤ (60-74%) - –ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ
- <40 –±–∞–ª—ñ–≤ (<60%) - –ù–µ–∑–∞–¥–æ–≤—ñ–ª—å–Ω–æ (–ø–µ—Ä–µ—Ä–æ–±–∏—Ç–∏)

---

### –ë–æ–Ω—É—Å–Ω—ñ –±–∞–ª–∏ (–¥–æ +5 –±–∞–ª—ñ–≤)

**–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—ñ—á—ñ (–æ–ø—Ü—ñ–π–Ω–æ):**

- ‚ú® **Custom validators** –∑ Bean Validation (–¥–æ +2)
- ‚ú® **Swagger –¥–µ—Ç–∞–ª—å–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è** –∑ –ø—Ä–∏–∫–ª–∞–¥–∞–º–∏ (–¥–æ +1)
- ‚ú® **Integration —Ç–µ—Å—Ç–∏** –¥–ª—è –≤—Å—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π (–¥–æ +2)
- ‚ú® **Docker Compose** –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ —Å—Ç–µ–∫—É (PostgreSQL + Redis + app) (–¥–æ +1)
- ‚ú® **Grafana dashboard** –¥–ª—è metrics (–¥–æ +2)

**–ú–∞–∫—Å–∏–º—É–º –±–æ–Ω—É—Å—ñ–≤:** 5 –±–∞–ª—ñ–≤ (–∑–∞–≥–∞–ª–æ–º –º–æ–∂–µ –±—É—Ç–∏ 70/65)

---

## ‚úÖ –ß–ï–ö-–õ–ò–°–¢ –ó–î–ê–ß–Ü STAGE 2

### –ü–µ—Ä–µ–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è–º Pull Request

**–ü—Ä–æ—î–∫—Ç:**
- [ ] –î–æ–¥–∞—Ç–æ–∫ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –±–µ–∑ –ø–æ–º–∏–ª–æ–∫
- [ ] PostgreSQL –ø—Ä–∞—Ü—é—î
- [ ] Redis –ø—Ä–∞—Ü—é—î
- [ ] –í—Å—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ

---

**Liquibase:**
- [ ] `db.changelog-master.yaml` –≤–∫–ª—é—á–∞—î –≤—Å—ñ changesets
- [ ] –ú—ñ–Ω—ñ–º—É–º 6 changesets —Å—Ç–≤–æ—Ä–µ–Ω–æ
- [ ] Rollback —Å–µ–∫—Ü—ñ—ó –ø—Ä–∏—Å—É—Ç–Ω—ñ
- [ ] Seed data (–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, —Ä–æ–ª—ñ, admin)
- [ ] `ddl-auto=none` –≤ application.properties
- [ ] –Ü–Ω–¥–µ–∫—Å–∏ —Å—Ç–≤–æ—Ä–µ–Ω—ñ

---

**MovementLog:**
- [ ] MovementLog Entity –∑ @Version
- [ ] MovementType enum
- [ ] MovementRepository –∑ Query Methods
- [ ] MovementService –∑ @Transactional(isolation = REPEATABLE_READ)
- [ ] issueItem, returnItem, writeOffItem –º–µ—Ç–æ–¥–∏
- [ ] –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∏
- [ ] MovementController –∑ endpoints
- [ ] Liquibase changeset –¥–ª—è movements

---

**JWT Security:**
- [ ] User —Ç–∞ Role Entity
- [ ] Liquibase –¥–ª—è users/roles
- [ ] Default admin (admin/admin123)
- [ ] JwtUtils (generate, validate)
- [ ] Secret key 256+ –±—ñ—Ç
- [ ] CustomUserDetailsService
- [ ] JwtAuthenticationFilter
- [ ] SecurityConfig
- [ ] AuthController (login, register)
- [ ] @PreAuthorize –Ω–∞ endpoints
- [ ] BCrypt password hashing

---

**MapStruct:**
- [ ] MapStruct dependency + annotation processor
- [ ] CategoryMapper
- [ ] ItemMapper –∑ –≤–∫–ª–∞–¥–µ–Ω–∏–º–∏ –æ–±'—î–∫—Ç–∞–º–∏
- [ ] Mappers inject –≤ Service
- [ ] –†—É—á–Ω–∏–π –º–∞–ø–ø—ñ–Ω–≥ –≤–∏–¥–∞–ª–µ–Ω–æ
- [ ] –ö–æ–¥ –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è
- [ ] –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω—ñ *MapperImpl.java

---

**Redis:**
- [ ] Redis Docker container
- [ ] Spring Data Redis dependency
- [ ] CacheConfig –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π
- [ ] @Cacheable –Ω–∞ read –º–µ—Ç–æ–¥–∞—Ö
- [ ] @CacheEvict –Ω–∞ write –º–µ—Ç–æ–¥–∞—Ö
- [ ] –ö–µ—à—É–≤–∞–Ω–Ω—è –ø—Ä–∞—Ü—é—î (–ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ)
- [ ] Redis –º—ñ—Å—Ç–∏—Ç—å –¥–∞–Ω—ñ

---

**Events:**
- [ ] –ú—ñ–Ω—ñ–º—É–º 2 Event –∫–ª–∞—Å–∏
- [ ] ApplicationEventPublisher inject
- [ ] publishEvent –≤ Service
- [ ] EventListener –∫–ª–∞—Å
- [ ] @TransactionalEventListener
- [ ] @Async
- [ ] @EnableAsync –≤ main –∫–ª–∞—Å—ñ

---

**Observability:**
- [ ] MetricsService
- [ ] Custom counters —Ç–∞ timers
- [ ] Metrics –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è
- [ ] /actuator/metrics –ø—Ä–∞—Ü—é—î
- [ ] Logback JSON encoder
- [ ] CorrelationIdFilter
- [ ] MDC –≤ Service

---

**–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:**
- [ ] Login –ø—Ä–∞—Ü—é—î (–æ—Ç—Ä–∏–º—É—î–º–æ JWT)
- [ ] Register –ø—Ä–∞—Ü—é—î
- [ ] Endpoints –∑ JWT ‚Üí 200
- [ ] Endpoints –±–µ–∑ JWT ‚Üí 403
- [ ] VIEWER –Ω–µ –º–æ–∂–µ DELETE ‚Üí 403
- [ ] Issue –ø—Ä–∞—Ü—é—î (—Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è Movement)
- [ ] Return –ø—Ä–∞—Ü—é—î
- [ ] Write-off –ø—Ä–∞—Ü—é—î
- [ ] –ö–µ—à—É–≤–∞–Ω–Ω—è –ø—Ä–∞—Ü—é—î (—à–≤–∏–¥—à–µ –ø—ñ—Å–ª—è –ø–µ—Ä—à–æ–≥–æ)
- [ ] Events –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è (–ª–æ–≥–∏)
- [ ] Metrics —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç—É—é—Ç—å—Å—è

---

### Git —Ç–∞ Pull Request

```bash
# 1. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∑–º—ñ–Ω–∏
git status

# 2. –î–æ–¥–∞—Ç–∏ –≤—Å—ñ —Ñ–∞–π–ª–∏
git add .

# 3. Commit
git commit -m "feat(stage2): implement enterprise features

- Liquibase migrations with seed data
- JWT Security with roles (ADMIN, OPERATOR, VIEWER)
- MapStruct auto-mapping
- Redis caching with TTL
- Spring Events (async)
- MovementLog with transactions
- Custom Metrics (Micrometer)
- Structured JSON logging
- Correlation ID tracing"

# 4. Push
git push origin stage-2
```

**–ù–∞ GitHub:**
1. –°—Ç–≤–æ—Ä–∏—Ç–∏ Pull Request: `stage-2` ‚Üí `main`
2. –î–æ–¥–∞—Ç–∏ label `stage-2`
3. –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –æ–ø–∏—Å PR:
   - –°–ø–∏—Å–æ–∫ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏—Ö —Ñ—ñ—á
   - –°–∫—Ä—ñ–Ω—à–æ—Ç–∏ Swagger/Postman
   - –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

---

## üÜò TROUBLESHOOTING

### Liquibase

**–ü–æ–º–∏–ª–∫–∞: "Validation Failed: changeset already exists"**

```
Caused by: liquibase.exception.ValidationFailedException: 
Validation Failed: 1 changesets check sum
```

**–ü—Ä–∏—á–∏–Ω–∞:** Changeset –∑–º—ñ–Ω–µ–Ω–æ –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

**–†—ñ—à–µ–Ω–Ω—è:**
```sql
-- –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–∞–±–ª–∏—Ü—é checksums
DELETE FROM databasechangelog WHERE id = '001-create-categories';

-- –ê–±–æ –ø–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç–∏ –ë–î
docker-compose down -v
docker-compose up -d
```

---

**–ü–æ–º–∏–ª–∫–∞: "Table already exists"**

**–ü—Ä–∏—á–∏–Ω–∞:** `ddl-auto=update` –Ω–µ –≤–∏–º–∫–Ω–µ–Ω–æ

**–†—ñ—à–µ–Ω–Ω—è:**
```properties
spring.jpa.hibernate.ddl-auto=none  # –û–ë–û–í'–Ø–ó–ö–û–í–û!
```

---

### JWT

**–ü–æ–º–∏–ª–∫–∞: "JWT signature does not match"**

**–ü—Ä–∏—á–∏–Ω–∞:** Secret key –∑–º—ñ–Ω–µ–Ω–æ –∞–±–æ < 256 –±—ñ—Ç

**–†—ñ—à–µ–Ω–Ω—è:**
```properties
# –ú—ñ–Ω—ñ–º—É–º 256 –±—ñ—Ç (32 —Å–∏–º–≤–æ–ª–∏)
app.jwt.secret=ThisIsAVerySecretKeyThatIsAtLeast256BitsLongForHS256AlgorithmToWorkProperly
```

---

**–ü–æ–º–∏–ª–∫–∞: 403 –Ω–∞–≤—ñ—Ç—å –∑ –≤–∞–ª—ñ–¥–Ω–∏–º token**

**–ü—Ä–∏—á–∏–Ω–∞:** –†–æ–ª—å –Ω–µ –º–∞—î –ø—Ä–µ—Ñ—ñ–∫—Å `ROLE_`

**–†—ñ—à–µ–Ω–Ω—è:**
```java
public enum RoleName {
    ROLE_ADMIN,  // ‚Üê –û–ë–û–í'–Ø–ó–ö–û–í–û ROLE_ prefix!
    ROLE_OPERATOR,
    ROLE_VIEWER
}
```

---

**–ü–æ–º–∏–ª–∫–∞: "UsernameNotFoundException" –ø—Ä–∏ login**

**–ü—Ä–∏—á–∏–Ω–∞:** UserDetailsService –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å user

**–†—ñ—à–µ–Ω–Ω—è:**
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —â–æ admin —Å—Ç–≤–æ—Ä–µ–Ω–∏–π —á–µ—Ä–µ–∑ Liquibase
2. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∞—î –±—É—Ç–∏ BCrypt hash)

```sql
SELECT * FROM users WHERE username = 'admin';
-- password –º–∞—î –ø–æ—á–∏–Ω–∞—Ç–∏—Å—å –∑ $2a$ (BCrypt)
```

---

### MapStruct

**–ü–æ–º–∏–ª–∫–∞: "Cannot find implementation for Mapper"**

**–ü—Ä–∏—á–∏–Ω–∞:** MapStruct –Ω–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞–≤ —ñ–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü—ñ—é

**–†—ñ—à–µ–Ω–Ω—è:**
```bash
# –ü–æ–≤–Ω–∞ –ø–µ—Ä–µ–∫–æ–º–ø—ñ–ª—è—Ü—ñ—è
mvn clean compile

# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ target/generated-sources/annotations
```

---

**–ü–æ–º–∏–ª–∫–∞: "No property found for mapping"**

**–ü—Ä–∏—á–∏–Ω–∞:** –Ü–º–µ–Ω–∞ –ø–æ–ª—ñ–≤ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å

**–†—ñ—à–µ–Ω–Ω—è:**
```java
@Mapping(source = "warehouse.id", target = "warehouseId")  // –Ø–≤–Ω–∏–π –º–∞–ø–ø—ñ–Ω–≥
```

---

### Redis

**–ü–æ–º–∏–ª–∫–∞: "Cannot get Jedis connection"**

**–ü—Ä–∏—á–∏–Ω–∞:** Redis –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π

**–†—ñ—à–µ–Ω–Ω—è:**
```bash
docker-compose ps
# –Ø–∫—â–æ redis –Ω–µ Up:
docker-compose up -d redis
```

---

**–ü–æ–º–∏–ª–∫–∞: –ö–µ—à—É–≤–∞–Ω–Ω—è –Ω–µ –ø—Ä–∞—Ü—é—î**

**–ü—Ä–∏—á–∏–Ω–∞:** `@EnableCaching` –Ω–µ –¥–æ–¥–∞–Ω–æ

**–†—ñ—à–µ–Ω–Ω—è:**
```java
@Configuration
@EnableCaching  // ‚Üê –î–æ–¥–∞–π—Ç–µ!
public class CacheConfig {
```

---

**–ü–æ–º–∏–ª–∫–∞: "Could not serialize object"**

**–ü—Ä–∏—á–∏–Ω–∞:** DTO –Ω–µ Serializable –∞–±–æ –º–∞—î circular reference

**–†—ñ—à–µ–Ω–Ω—è:**
1. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ `GenericJackson2JsonRedisSerializer`
2. –£–Ω–∏–∫–∞–π—Ç–µ circular references –≤ DTO
3. –î–æ–¥–∞–π—Ç–µ `@JsonIgnore` –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ñ –ø–æ–ª—è

---

### Events

**–ü–æ–º–∏–ª–∫–∞: EventListener –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è**

**–ü—Ä–∏—á–∏–Ω–∞:** @EnableAsync –Ω–µ –¥–æ–¥–∞–Ω–æ –∞–±–æ listener –Ω–µ @Component

**–†—ñ—à–µ–Ω–Ω—è:**
```java
@SpringBootApplication
@EnableAsync  // ‚Üê –û–ë–û–í'–Ø–ó–ö–û–í–û
public class WarehouseApplication {
```

```java
@Component  // ‚Üê –û–ë–û–í'–Ø–ó–ö–û–í–û
public class EventListener {
```

---

**–ü–æ–º–∏–ª–∫–∞: Event –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–º–∞—î @Async

**–†—ñ—à–µ–Ω–Ω—è:**
```java
@EventListener
@Async  // ‚Üê –î–æ–¥–∞–π—Ç–µ –¥–ª—è async
public void handleEvent(MyEvent event) {
```

---

### Metrics

**–ü–æ–º–∏–ª–∫–∞: /actuator/metrics ‚Üí 404**

**–ü—Ä–∏—á–∏–Ω–∞:** Actuator endpoints –Ω–µ exposed

**–†—ñ—à–µ–Ω–Ω—è:**
```properties
management.endpoints.web.exposure.include=health,metrics,prometheus
```

---

## üéì –ü–û–†–ê–î–ò –í–ò–ö–õ–ê–î–ê–ß–ê

### –¢–∏–ø–æ–≤—ñ –ø–æ–º–∏–ª–∫–∏ –∫—É—Ä—Å–∞–Ω—Ç—ñ–≤ Stage 2

1. **–ó–∞–±—É–≤–∞—é—Ç—å –≤–∏–º–∫–Ω—É—Ç–∏ `ddl-auto`**
   - Hibernate —ñ Liquibase –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—Ç—å
   - –†–æ–∑–≤'—è–∑–∫–∞: `spring.jpa.hibernate.ddl-auto=none`

2. **Weak JWT secret (<256 –±—ñ—Ç)**
   - JJWT –≤–∏–º–∞–≥–∞—î –º—ñ–Ω—ñ–º—É–º 256 –±—ñ—Ç –¥–ª—è HS256
   - –†–æ–∑–≤'—è–∑–∫–∞: –º—ñ–Ω—ñ–º—É–º 32 —Å–∏–º–≤–æ–ª–∏

3. **–†–æ–ª—å –±–µ–∑ `ROLE_` prefix**
   - Spring Security –≤–∏–º–∞–≥–∞—î —Ü–µ–π prefix
   - –†–æ–∑–≤'—è–∑–∫–∞: `ROLE_ADMIN`, –Ω–µ `ADMIN`

4. **–ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å MapStruct –ø—ñ—Å–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è**
   - –°—Ç–≤–æ—Ä–∏–ª–∏ mappers –∞–ª–µ –∑–∞–ª–∏—à–∏–ª–∏ —Ä—É—á–Ω–∏–π –º–∞–ø–ø—ñ–Ω–≥
   - –†–æ–∑–≤'—è–∑–∫–∞: –≤–∏–¥–∞–ª—ñ—Ç—å –≤—Å—ñ `toDTO()` –º–µ—Ç–æ–¥–∏ –∑ Service

5. **@Async –±–µ–∑ @EnableAsync**
   - Events –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
   - –†–æ–∑–≤'—è–∑–∫–∞: `@EnableAsync` –≤ main –∫–ª–∞—Å—ñ

6. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Isolation —Ä—ñ–≤–µ–Ω—å**
   - –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `READ_COMMITTED` –∞–±–æ –Ω–µ–º–∞—î –≤–∑–∞–≥–∞–ª—ñ
   - –†–æ–∑–≤'—è–∑–∫–∞: `@Transactional(isolation = Isolation.REPEATABLE_READ)`

7. **–ó–∞–±—É–≤–∞—é—Ç—å @Version –¥–ª—è Optimistic Locking**
   - –ú–æ–∂–ª–∏–≤—ñ race conditions
   - –†–æ–∑–≤'—è–∑–∫–∞: –¥–æ–¥–∞–π—Ç–µ `@Version private Long version;`

8. **–ö–µ—à—É—é—Ç—å –¥–∞–Ω—ñ —â–æ —á–∞—Å—Ç–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è**
   - –ù–∞–ø—Ä–∏–∫–ª–∞–¥ –∫–µ—à—É—é—Ç—å `item.quantity`
   - –†–æ–∑–≤'—è–∑–∫–∞: –∫–µ—à—É–π—Ç–µ —Ç—ñ–ª—å–∫–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ –¥–∞–Ω—ñ

---

### –Ø–∫ –ø—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏—Å—è –¥–æ –∑–¥–∞—á—ñ

**–ó–∞ –¥–µ–Ω—å –¥–æ –∑–¥–∞—á—ñ:**

1. ‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—ñ —Å–µ—Ä–≤—ñ—Å–∏**
   ```bash
   docker-compose ps
   # postgres, redis - –æ–±–∏–¥–≤–∞ Up
   ```

2. ‚úÖ **–ó–∞–ø—É—Å—Ç—ñ—Ç—å –¥–æ–¥–∞—Ç–æ–∫**
   ```bash
   mvn spring-boot:run
   # –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –ª–æ–≥–∏ - –Ω–µ–º–∞—î –ø–æ–º–∏–ª–æ–∫
   ```

3. ‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ —á–µ—Ä–µ–∑ Postman**
   - Login ‚Üí –æ—Ç—Ä–∏–º–∞—Ç–∏ JWT
   - –í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ JWT –¥–ª—è –≤—Å—ñ—Ö –∑–∞–ø–∏—Ç—ñ–≤
   - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∫–æ–∂–µ–Ω endpoint

4. ‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ Redis**
   ```bash
   docker exec -it military-warehouse-redis redis-cli
   127.0.0.1:6379> KEYS *
   # –ú–∞—î –±—É—Ç–∏ –∫–ª—é—á—ñ –ø—ñ—Å–ª—è –∑–∞–ø–∏—Ç—ñ–≤
   ```

5. ‚úÖ **–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ metrics**
   ```bash
   curl http://localhost:8080/actuator/metrics
   # –ú–∞—î –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —Å–ø–∏—Å–æ–∫ metrics
   ```

---

**–ü—ñ–¥ —á–∞—Å –∑–¥–∞—á—ñ:**

1. **–ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—é:**
   - Postman collection –∑ —É—Å—ñ–º–∞ –∑–∞–ø–∏—Ç–∞–º–∏
   - –ó–∞–∑–¥–∞–ª–µ–≥—ñ–¥—å —Å—Ç–≤–æ—Ä–µ–Ω—ñ —Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ
   - –ó–Ω–∞–π—Ç–µ —è–∫—ñ endpoints –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏

2. **–ë—É–¥—å—Ç–µ –≥–æ—Ç–æ–≤—ñ –ø–æ—è—Å–Ω–∏—Ç–∏:**
   - –ß–æ–º—É –æ–±—Ä–∞–ª–∏ REPEATABLE_READ isolation?
   - –Ø–∫ –ø—Ä–∞—Ü—é—î JWT authentication flow?
   - –ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω Correlation ID?
   - –©–æ —Ç–∞–∫–µ Optimistic Locking?
   - –Ø–∫ MapStruct –≥–µ–Ω–µ—Ä—É—î –∫–æ–¥?
   - –†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ @EventListener —Ç–∞ @TransactionalEventListener?

3. **–ü—ñ–¥–≥–æ—Ç—É–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è:**
   - –Ø–∫—ñ metrics –∑–±–∏—Ä–∞—î—Ç–µ —ñ –Ω–∞–≤—ñ—â–æ?
   - –Ø–∫ invalidate –∫–µ—à –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ?
   - –©–æ –±—É–¥–µ —è–∫—â–æ –¥–≤–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –≤–∏–¥–∞–¥—É—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª?
   - –Ø–∫ –ø—Ä–∞—Ü—é—î @Async event processing?
   - –ß–æ–º—É events –∫—Ä–∞—â–µ –Ω—ñ–∂ –ø—Ä—è–º—ñ –≤–∏–∫–ª–∏–∫–∏?

---

## üéØ –§–Ü–ù–ê–õ–¨–ù–Ü –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á

### –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è

**–©–æ —Ä–æ–±–∏—Ç–∏ –î–û–ë–†–ï:**

‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó:**
```java
@Transactional(
    isolation = Isolation.REPEATABLE_READ,
    rollbackFor = Exception.class
)
```
- –Ø–≤–Ω–∏–π isolation —Ä—ñ–≤–µ–Ω—å
- rollbackFor –≤—Å—ñ—Ö Exception

‚úÖ **Security:**
```java
@PreAuthorize("hasAnyRole('ADMIN', 'OPERATOR')")
```
- –ì—Ä–∞–Ω—É–ª—å–æ–≤–∞–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É
- –†—ñ–∑–Ω—ñ —Ä–æ–ª—ñ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π

‚úÖ **–ö–µ—à—É–≤–∞–Ω–Ω—è:**
```java
@Cacheable(
    value = "categories",
    key = "#id",
    condition = "#result != null"
)
```
- –ö–µ—à—É–≤–∞—Ç–∏ —Å—Ç–∞–±—ñ–ª—å–Ω—ñ –¥–∞–Ω—ñ
- –ü—Ä–∞–≤–∏–ª—å–Ω–∏–π TTL
- Invalidation –ø—Ä–∏ –∑–º—ñ–Ω–∞—Ö

‚úÖ **Events:**
```java
@TransactionalEventListener(phase = AFTER_COMMIT)
@Async
```
- Async –¥–ª—è performance
- AFTER_COMMIT –¥–ª—è consistency

---

**–ß–æ–≥–æ –ù–ï —Ä–æ–±–∏—Ç–∏:**

‚ùå **–¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó:**
```java
@Transactional  // –ë–µ–∑ isolation - –Ω–µ–±–µ–∑–ø–µ—á–Ω–æ!
```

‚ùå **Security:**
```java
public enum RoleName {
    ADMIN  // ‚Üê –ë–µ–∑ ROLE_ prefix - –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ!
}
```

‚ùå **–ö–µ—à—É–≤–∞–Ω–Ω—è:**
```java
@Cacheable("items")  // ‚Üê –ö–µ—à—É—î item.quantity - –ø–æ–≥–∞–Ω–∞ —ñ–¥–µ—è!
```

‚ùå **Events:**
```java
@EventListener  // ‚Üê –ë–µ–∑ @Async - –±–ª–æ–∫—É—î –æ—Å–Ω–æ–≤–Ω–∏–π –ø–æ—Ç—ñ–∫
```

---

### Production-Ready Checklist

**–Ø–∫—â–æ —Ü–µ –±—É–≤ —Ä–µ–∞–ª—å–Ω–∏–π production –ø—Ä–æ–µ–∫—Ç:**

1. ‚úÖ **Security:**
   - JWT secret –≤ environment variables (–Ω–µ –≤ –∫–æ–¥—ñ!)
   - HTTPS only
   - Rate limiting
   - CORS –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π

2. ‚úÖ **Database:**
   - Connection pooling (HikariCP)
   - Read replicas –¥–ª—è –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è
   - Backup strategy
   - Migration rollback plan

3. ‚úÖ **Caching:**
   - Redis Sentinel (high availability)
   - Cache warming strategy
   - Eviction policy

4. ‚úÖ **Observability:**
   - Prometheus + Grafana
   - ELK Stack –¥–ª—è –ª–æ–≥—ñ–≤
   - Alerting rules
   - SLA monitoring

5. ‚úÖ **Resilience:**
   - Circuit breakers
   - Retry mechanisms
   - Graceful degradation
   - Health checks

---

## üéâ –ó–ê–í–ï–†–®–ï–ù–ù–Ø

**–í—ñ—Ç–∞—î–º–æ! –í–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏ Stage 2!**

### –©–æ –≤–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏:

**üéØ Production-Ready Backend –∑:**

1. ‚úÖ **Liquibase** - –≤–µ—Ä—Å—ñ–π–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ë–î
2. ‚úÖ **JWT Security** - –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Ç–∞ RBAC
3. ‚úÖ **MapStruct** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –º–∞–ø–ø—ñ–Ω–≥
4. ‚úÖ **Redis Caching** - –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
5. ‚úÖ **Spring Events** - event-driven architecture
6. ‚úÖ **MovementLog** - —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π–Ω–∏–π –∞—É–¥–∏—Ç
7. ‚úÖ **Optimistic Locking** - concurrency control
8. ‚úÖ **Custom Metrics** - –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
9. ‚úÖ **Structured Logging** - observability
10. ‚úÖ **Correlation ID** - distributed tracing

---

### –©–æ –≤–∏ –Ω–∞–≤—á–∏–ª–∏—Å—å:

**üí° –ö–æ–Ω—Ü–µ–ø—Ü—ñ—ó:**
- Database migrations
- JWT authentication flow
- Code generation (MapStruct)
- Distributed caching
- Event-driven architecture
- Transaction isolation levels
- Optimistic vs Pessimistic locking
- Metrics collection
- Structured logging
- Distributed tracing

**üõ†Ô∏è –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó:**
- Liquibase
- JJWT
- MapStruct
- Redis
- Spring Events
- Micrometer
- Logback
- Docker Compose

**üèóÔ∏è Patterns:**
- Repository Pattern
- Service Layer Pattern
- DTO Pattern
- Event Sourcing (–±–∞–∑–æ–≤–∏–π)
- CQRS (–±–∞–∑–æ–≤–∏–π)
- Saga Pattern (–±–∞–∑–æ–≤–∏–π —á–µ—Ä–µ–∑ Events)

---

### –í–∞—à –ø—Ä–æ–µ–∫—Ç —Ç–µ–ø–µ—Ä:

‚úÖ **Enterprise-grade** - –≥–æ—Ç–æ–≤–∏–π –¥–æ production
‚úÖ **Scalable** - –º–æ–∂–Ω–∞ –º–∞—Å—à—Ç–∞–±—É–≤–∞—Ç–∏ (Redis, Read replicas)
‚úÖ **Secure** - JWT + RBAC
‚úÖ **Observable** - metrics + structured logs
‚úÖ **Maintainable** - Liquibase + MapStruct
‚úÖ **Performant** - caching + async events
‚úÖ **Resilient** - transactions + locking

---

### –¶–µ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤ –ø–æ—Ä—Ç—Ñ–æ–ª—ñ–æ!

**–í–∞—à GitHub README –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏:**

```markdown
# Military Warehouse Management System

Production-ready REST API for military logistics management.

## üöÄ Features

- **JWT Authentication** with role-based access control
- **Database Migrations** with Liquibase
- **Redis Caching** for performance optimization
- **Event-Driven Architecture** with Spring Events
- **Transaction Management** with optimistic locking
- **Observability** with custom metrics and structured logging
- **Auto-Mapping** with MapStruct
- **REST API** with OpenAPI documentation

## üõ†Ô∏è Tech Stack

- Java 17
- Spring Boot 3.2
- Spring Security (JWT)
- Spring Data JPA
- PostgreSQL 15
- Redis 7
- Liquibase
- MapStruct
- Micrometer
- Docker

## üìä Architecture

[–í—Å—Ç–∞–≤–∏—Ç–∏ –¥—ñ–∞–≥—Ä–∞–º—É]

## üîß Setup

[–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó]
```

---

### –ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏ (–æ–ø—Ü—ñ–π–Ω–æ –¥–ª—è —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ–≥–æ —Ä–æ–∑–≤–∏—Ç–∫—É):

**–Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ —Ä–æ–∑–≤–∏–≤–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç:**

1. üöÄ **Frontend:**
   - React + TypeScript
   - Material-UI –∞–±–æ Ant Design
   - JWT token management
   - WebSocket –¥–ª—è real-time updates

2. üöÄ **Advanced Security:**
   - OAuth2 / OpenID Connect
   - Refresh tokens
   - MFA (Multi-Factor Authentication)
   - Audit logging

3. üöÄ **Microservices:**
   - –†–æ–∑–¥—ñ–ª–∏—Ç–∏ –Ω–∞ –æ–∫—Ä–µ–º—ñ —Å–µ—Ä–≤—ñ—Å–∏
   - API Gateway (Spring Cloud Gateway)
   - Service Discovery (Eureka)
   - Distributed tracing (Zipkin)

4. üöÄ **DevOps:**
   - CI/CD pipeline (GitHub Actions)
   - Kubernetes deployment
   - Helm charts
   - Monitoring stack (Prometheus + Grafana)

5. üöÄ **Advanced Features:**
   - WebSocket notifications
   - File upload/download
   - Report generation (PDF/Excel)
   - Email notifications
   - Scheduled tasks (Cron jobs)

---

## üôè –î–Ø–ö–£–Æ –ó–ê –£–í–ê–ì–£!

**–£—Å–ø—ñ—Ö—ñ–≤ –Ω–∞ –ø—Ä–∞–∫—Ç–∏—á–Ω–æ–º—É –∑–∞–Ω—è—Ç—Ç—ñ!** üéØ

**–ü–∞–º'—è—Ç–∞–π—Ç–µ:**
- –ß–∏—Ç–∞–π—Ç–µ –ø–æ–º–∏–ª–∫–∏ —É–≤–∞–∂–Ω–æ
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –ª–æ–≥–∏
- –¢–µ—Å—Ç—É–π—Ç–µ –∫–æ–∂–Ω—É —Ñ—ñ—á—É –æ–∫—Ä–µ–º–æ
- –ü–∏—Ç–∞–π—Ç–µ —è–∫—â–æ —â–æ—Å—å –Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–æ
- –ù–µ –∫–æ–ø—ñ—é–π—Ç–µ –∫–æ–¥ —Å–ª—ñ–ø–æ - —Ä–æ–∑—É–º—ñ–π—Ç–µ —â–æ —Ä–æ–±–∏—Ç–µ

**–í–∞—à –ø—Ä–æ–µ–∫—Ç - —Ü–µ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—è –≤ –º–∞–π–±—É—Ç–Ω—î!** üí™

---

## üìö –ö–û–†–ò–°–ù–Ü –ü–û–°–ò–õ–ê–ù–ù–Ø

**–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è:**
- [Liquibase Docs](https://docs.liquibase.com/)
- [Spring Security JWT](https://docs.spring.io/spring-security/reference/servlet/oauth2/resource-server/jwt.html)
- [MapStruct Reference](https://mapstruct.org/documentation/stable/reference/html/)
- [Redis Documentation](https://redis.io/documentation)
- [Spring Events](https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#context-functionality-events)
- [Micrometer](https://micrometer.io/docs)

**–¢—É—Ç–æ—Ä—ñ–∞–ª–∏:**
- [Baeldung - Spring Security JWT](https://www.baeldung.com/spring-security-oauth-jwt)
- [Baeldung - Liquibase](https://www.baeldung.com/liquibase-refactor-schema-of-java-app)
- [Baeldung - MapStruct](https://www.baeldung.com/mapstruct)
- [Baeldung - Spring Events](https://www.baeldung.com/spring-events)

**–ö–Ω–∏–≥–∏:**
- "Spring in Action" (Craig Walls)
- "Spring Security in Action" (Lauren»õiu SpilcƒÉ)
- "Effective Java" (Joshua Bloch)
- "Database Migrations with Liquibase" (Practical Guide)

---

**–¶–µ –∫—ñ–Ω–µ—Ü—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó PZ_2_2!**

–°—Ç–≤–æ—Ä–µ–Ω–æ –∑ ‚ù§Ô∏è –¥–ª—è –∫—É—Ä—Å–∞–Ω—Ç—ñ–≤ –í–Ü–¢–Ü

